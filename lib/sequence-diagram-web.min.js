!function(){"use strict";function t(t,e,n=null){if(null===n)return t.indexOf(e);for(let r=0;r<t.length;++r)if(n(t[r],e))return r;return-1}function e(e,n=null,r=null){if(n)for(let s=0;s<n.length;++s)-1===t(e,n[s],r)&&e.push(n[s])}function n(e,n=null,r=null){if(n)for(let s=0;s<n.length;++s){const i=t(e,n[s],r);-1!==i&&e.splice(i,1)}}function r(e,n,r=null){const s=t(e,n,r);-1!==s&&e.splice(s,1)}function s(t){return t[t.length-1]}function i(t,e,n,r){if(e>=t.length)return void r.push(n.slice());const s=t[e];if(!Array.isArray(s))return n.push(s),i(t,e+1,n,r),void n.pop();for(let a=0;a<s.length;++a)n.push(s[a]),i(t,e+1,n,r),n.pop()}function a(t,e){const n=[];return t.forEach(t=>{n.push(...e(t))}),n}function o(t,e){const n=Gt[t.type];return!(!n||t.type!==e.type)&&!n.check.some(n=>t[n]!==e[n])}function l(t,n){Gt[t.type].merge.forEach(r=>{e(t[r],n[r])})}function h(t,e){for(let n=0;n<t.length;){e(t[n],n)?t.splice(n,1):++n}}function d(t){h(t,(e,n)=>{for(let r=0;r<n;++r)if(o(t[r],e))return l(t[r],e),!0;return!1})}function g(t){const e=new Set,n=t.map(({type:t})=>t);return n.forEach(t=>{const r=Gt[t];r&&n.every(e=>t===e||r.siblings.has(e))&&e.add(t)}),e}function c(t,e,n,r){h(r,r=>{if(!t.has(r.type)||!e.has(r.type))return!1;for(let t=0;t<n.length;++t)if(o(n[t],r))return l(n[t],r),!0;return!1})}function u(t,e){for(const n of e)n&&("parallel"===n.type?u(t,n.stages):t.push(n))}function p(t,e){if(!t)return"Nothing to run statement in parallel with";const n=[];return u(n,[t]),u(n,[e]),n.some(t=>!Dt.includes(t.type))?"Cannot use parallel here":function(t){const e=a(t.filter(t=>"agent begin"===t.type),t=>t.agentIDs);for(const n of t)if("agent end"===n.type)for(const t of n.agentIDs)if(-1!==e.indexOf(t))return"Cannot create and destroy "+t+" simultaneously";return null}(n)||function(t){const e=t.filter(t=>"block begin"===t.type||"block end"===t.type).length;if(!e)return null;if(e!==t.length)return"Cannot use parallel here";const n=t.filter(t=>"block begin"===t.type).map(t=>t.left);for(const e of t)if("block end"===e.type&&-1!==n.indexOf(e.left))return"Cannot create and destroy reference simultaneously";return null}(n)||function(t){const e=t.filter(t=>"connect-delay-begin"===t.type).map(t=>t.tag);for(const n of t)if("connect-delay-end"===n.type&&-1!==e.indexOf(n.tag))return"Cannot start and finish delayed connection simultaneously";return null}(n)}function f(t,e){if("agent begin"===t.type)return t.mode=e,!0;if("parallel"===t.type){let n=!1;return t.stages.forEach(t=>{"agent begin"===t.type&&(t.mode=e,n=!0)}),n}return!1}function m(t,e,n,s=null){r(t,e,Ct.equals),r(t,n,Ct.equals);let i=0,a=t.length;if(s){const e=s.map(e=>Ct.indexOf(t,e)).filter(t=>-1!==t);i=e.reduce((t,e)=>Math.min(t,e),t.length),a=e.reduce((t,e)=>Math.max(t,e),i)+1}return t.splice(i,0,e),t.splice(a+1,0,n),{indexL:i,indexR:a+1}}function b(t,e=[]){return{type:"string",suggest:e,then:Object.assign({"":0},t)}}function y(t,e){return t.v===e.v&&t.prefix===e.prefix&&t.suffix===e.suffix&&t.q===e.q}function x(t,e,n){return a(n.suggest||[""],r=>{if("object"==typeof r)return r.known?t["known"+r.known]||[]:[r];if(""===r)return[function(t,e){return Object.keys(e.then).length>0?{q:!1,suffix:" ",v:t}:{q:!1,suffix:"\n",v:t}}(e,n)];if("string"==typeof r)return[{q:""===e,v:r}];throw new Error("Invalid suggestion type "+r)})}function w(t,n){const r=[],i=s(n);return Object.keys(i.then).forEach(s=>{let a=i.then[s];"number"==typeof a&&(a=n[n.length-a-1]),e(r,x(t,s,a),y)}),r}function k(t,n,r,s){const i=function(t){for(const e of t)if("object"==typeof e&&e.known)return e.known;return null}(s.suggest||[""]);n.type&&i!==n.type&&(!function(t,n,r){e(t["known"+n],[{q:!0,suffix:" ",v:r}],y)}(t,s.override||n.type,n.value),n.value=""),i&&(n.value=function(t,e){return t+(t?e.s:"")+e.v}(n.value,r)),n.type=i}function v(t,e,n){const r={type:"",value:""};let i=n;const a=[i];return t.line.forEach((e,n)=>{n===t.line.length-1&&(t.completions=w(t,a));const o=e.q?"":e.v;let l=i.then[o];void 0===l?(l=i.then[""],t.isVar=!0):t.isVar=e.q,"number"==typeof l?a.length-=l:a.push(l||Ht),i=s(a),k(t,r,e,i)}),e&&k(t,r,null,{}),t.nextCompletions=w(t,a),t.valid=Boolean(i.then["\n"])||0===Object.keys(i.then).length,i.type}function A(t){const e=t.baseToken||{};return{quoted:e.q||!1,value:e.v||""}}function F(t,e,n){return e.lastIndex=n,e.exec(t)}function S(t,e,n){return n?function(t,e,n){if(n.escape){const r=F(t,n.escape,e);if(r)return{appendSpace:"",appendValue:n.escapeWith(r),end:!1,newBlock:null,skip:r[0].length}}const r=F(t,n.end,e);return r?{appendSpace:"",appendValue:n.includeEnd?r[0]:"",end:!0,newBlock:null,skip:r[0].length}:{appendSpace:"",appendValue:t[e],end:!1,newBlock:null,skip:1}}(t,e,n):function(t,e){for(let n=0;n<Wt.length;++n){const r=Wt[n],s=F(t,r.start,e);if(s)return{appendSpace:"",appendValue:"",end:!r.end,newBlock:r,skip:s[0].length}}return{appendSpace:t[e],appendValue:"",end:!1,newBlock:null,skip:1}}(t,e)}function M(t){return{ch:t.ch,i:t.i,ln:t.ln}}function R(t){const e=Jt.exec(t);return e&&e[1]?e[1].length:0}function C(t){if("label"===t)return{token:"label"};const e=t.indexOf(" ");let n=null,r=null;-1===e?(n=t,r=[]):(n=t.substr(0,e),r=t.substr(e+1).split(","));let s=null;return"inc"===n&&(s=function(t){let e=1,n=1,r=0;return t[0]&&(e=Number(t[0]),r=Math.max(r,R(t[0]))),t[1]&&(n=Number(t[1]),r=Math.max(r,R(t[1]))),Number.isNaN(e)||Number.isNaN(n)?null:{dp:r,inc:n,start:e}}(r)),s||"<"+t+">"}function I(t,e,n){const r=" "+t+" ";let s=-1,i=r.length,a=0;return Zt.forEach(({begin:t,end:o},l)=>{const h=n[l]?o:t;h.lastIndex=e;const d=h.exec(r);d&&(d.index<i||d.index===i&&h.lastIndex>a)&&(s=l,i=d.index,a=h.lastIndex)}),{end:a-1,start:i,styleIndex:s}}function E(t,e){if(!t)return null;const n={};return e.forEach((t,e)=>{t&&Object.assign(n,Zt[e].attrs)}),n}function G(t){return t.replace(/^[\f\n\r\t\v ]+|[\f\n\r\t\v ]+$/g,"")}function D(t){if(!t)return[];const e=Zt.map(()=>!1);let n=0,r=null;const s=[];return G(t).split("\n").forEach(t=>{const i=function(t){return t.replace(/[\f\n\r\t\v ]+/g," ")}(G(t)),a=[];let o=0;for(;;){const{styleIndex:t,start:s,end:l}=I(i,o,e);if(-1===t)break;e[t]?(e[t]=!1,--n):(e[t]=!0,++n),s>o&&a.push({attrs:r,text:i.substring(o,s)}),r=E(n,e),o=l}o<i.length&&a.push({attrs:r,text:i.substr(o)}),s.push(a)}),s}function L(t,e=null){let n="";return e&&(n=" at line "+(e.b.ln+1)+", character "+e.b.ch),new Error(t+n)}function N(t,e=null){return null===e?t.length:e}function O(t,e=0,n=null){const r=N(t,n);if(r<=e)return"";let s=t[e].v;for(let n=e+1;n<r;++n)s+=t[n].s+t[n].v;return s}function z(t){return!t||t.q?null:t.v}function V(t,e,n,r=null){for(let s=0;s<n.length;++s){const i=n[s],a=t[e+s];if(z(a)!==i){if(r)throw L(r+'; expected "'+i+'"',a);return e}}return e+n.length}function B(t,e,{start:n=0,limit:r=null,orEnd:s=!1}={}){const i=N(t,r);for(let r=n;r<=i-e.length;++r)if(V(t,r,e)!==r)return r;return s?i:-1}function T(t,e,n,{flagTypes:r={},aliases:i=!1}={}){const a=[],o=[];let l=e,h=!1;for(;l<n;++l){const e=t[l],n=z(e),s=r[n];if(!s)break;if(a.includes(s.flag))throw L("Duplicate agent flag: "+n,e);h=h||Boolean(s.allowBlankName),a.push(s.flag),o.push(s.blankNameFlag)}const{name:d,alias:g}=function(t,e,n,{enableAlias:r,allowBlankName:i}){let a=n;if(r&&(a=B(t,["as"],{limit:n,orEnd:!0,start:e})),e>=a&&!i){let n=t[e];throw n||(n={b:s(t).e}),L("Missing agent name",n)}return{alias:O(t,a+1,n),name:O(t,e,a)}}(t,l,n,{allowBlankName:h,enableAlias:i});return{alias:g,flags:d?a:o,name:d}}function H(t,e,n,r){const s=[];let i=-1;for(let a=e;a<n;++a){","===z(t[a])?-1!==i&&(s.push(T(t,i,a,r)),i=-1):-1===i&&(i=a)}return-1!==i&&s.push(T(t,i,n,r)),s}function P(t,{meta:e,stages:n}){let r=!1;const[s]=t;"&"===z(s)&&(r=!0,t.splice(0,1));const i=function(t,e){for(const{begin:n,fn:r}of re){if(V(t,0,n)!==n.length)continue;const s=r(t,e);if(s)return s}return null}(t,e);if(!i)throw L("Unrecognised command: "+O(t),t[0]);if("object"==typeof i)i.ln=s.b.ln,i.parallel=r,n.push(i);else if(r)throw L("Metadata cannot be parallel",s)}function j({agentIDs:t=[],topShift:e=0,y:n=null,asynchronousY:r=null}={},s=null){let i=e;return null!==n&&null!==s&&(i=Math.max(i,n-s)),{agentIDs:t,asynchronousY:null===r?s:r,topShift:i,y:n}}function q(t,e){oe.set(t,e)}function Y(t,e){let n=null,r=null;return e.forEach(e=>{const s=t.get(e);(null===n||s.index<n.index)&&(n=s),(null===r||s.index>r.index)&&(r=s)}),{left:n.id,right:r.id}}function U(t=null,e=null){return null===t?e:null===e?t:Math.max(t,e)}function W(t,n){return e(t.agentIDs,n.agentIDs),{agentIDs:t.agentIDs,asynchronousY:U(t.asynchronousY,n.asynchronousY),topShift:Math.max(t.topShift,n.topShift),y:U(t.y,n.y)}}function X(t){return null===t?null:t.element?t.element:t}function Q(t,e,n){if(!Array.isArray(n))throw new Error("Invalid formatted text line: "+n);n.forEach(({text:n,attrs:r})=>{r?e.add(t.el("tspan").attrs(r).add(n)):e.add(n)})}function J(t,e){let n=null,r=null;return e.forEach(e=>{const s=t.get(e);(null===n||s.index<n.index)&&(n=s),(null===r||s.index>r.index)&&(r=s)}),{left:n.id,right:r.id}}function Z(t,e){return t.v===e.v&&t.prefix===e.prefix&&t.suffix===e.suffix&&t.q===e.q}function K(t,e,n){const r=t.getLine(e),s={squash:{ch:n,line:e},word:{ch:n,line:e}};return n>0&&" "===r[n-1]&&(We.after.includes(r[n-2])&&s.word.ch--,s.squash.ch--),s}function _(t,e,n){const r=function({v:t,q:e,prefix:n="",suffix:r=""},s){const i=s||!Qe.test(t)?s:'"';return n+(i&&e?i+t.replace(Je,"\\$&")+i:t)+r}(t,n),s=t.q?e.fromVar:e.fromKey;return"\n"===r?{className:"pick-virtual",displayFrom:null,displayText:"<END>",from:s.squash,text:"\n",to:e.to.squash}:{className:null,displayFrom:s.word,displayText:r.trim(),from:We.start.test(r)?s.squash:s.word,text:r,to:We.end.test(r)?e.to.squash:e.to.word}}function $({global:t,prefix:e="",suffix:n=""},r){const s=r[t];return s?s.map(t=>({prefix:e,q:!0,suffix:n,v:t})):[]}function tt(t,n,r){let s=null;return s=t.ch>0&&n.state.line.length>0?n.state.completions.slice():n.state.beginCompletions.concat(n.state.knownAgent),function(t,n={}){for(let r=0;r<t.length;)t[r].global?(e(t,$(t[r],n),Z),t.splice(r,1)):++r}(s,r),s}function et(t,e){const n=t.getCursor(),r=function(t,e){const n=t.getLineTokens(e.line);for(let t=0;t<n.length;++t)if(n[t].end>=e.ch){n.length=t+1;break}return n}(t,n),i=s(r)||t.getTokenAt(n),a=function(t,e){let n="",r=0,s=0;t.forEach(t=>{t.state.isVar?(n+=t.string,s=t.end):(n="",r=t.end)}),s>e.ch&&(n=n.substr(0,e.ch-r));const i=Ue.exec(n);n=i[2];let a="";return Xe.test(n)&&(a=n.charAt(0),n=n.substr(1)),{from:r+i[1].length,partial:n,quote:a,valid:s>=r}}(r,n),o=function(t,e){let n=t.string;t.end>e.ch&&(n=n.substr(0,e.ch-t.start));const r=Ue.exec(n);return{from:t.start+r[1].length,partial:r[2],valid:!0}}(i,n),l=tt(n,i,t.options.globals),h={fromKey:K(t,n.line,o.from),fromVar:K(t,n.line,a.from),to:function(t,e,n){const r={squash:{ch:n,line:e},word:{ch:n,line:e}};return" "===t.getLine(e)[n]&&r.squash.ch++,r}(t,n.line,i.end)};let d=null;const g=l.filter(t=>(t.q||!a.quote)&&function(t,e){return e.valid&&t.startsWith(e.partial)}(t.v,t.q?a:o)).map(t=>e.completeSingle||t.v!==(t.q?a:o).partial?_(t,h,a.quote):(d=t,null)).filter(t=>null!==t);return d&&g.length>0&&g.unshift(_(d,h,a.quote)),{from:function(t,e){let n=null;return t.forEach(({displayFrom:t})=>{t&&(!n||t.line>n.line||t.line===n.line&&t.ch>n.ch)&&(n=t)}),n||e.word}(g,h.fromKey),list:g,to:h.to.word}}function nt(t,e="sequence"){const n=t||window.CodeMirror;n.defineMode(e,()=>$e),n.registerHelper("hint",e,et)}function rt(t){const e=(new DOMParser).parseFromString(t,"image/svg+xml").querySelector("metadata");return e?e.textContent:""}function st(t){function e(t,e){n.push(e)}const n=[];if(t.forEach(t=>{t.addEventListener("error",e),t.optimisedRenderPreReflow()}),t.forEach(t=>{t.optimisedRenderReflow()}),t.forEach(t=>{t.optimisedRenderPostReflow(),t.removeEventListener("error",e)}),n.length>0)throw n}function it(t,e=null,n={}){if("svg"===t.tagName)return null;const r=function(t){return{interactive:function(t){return void 0!==t&&"false"!==t}(t.dataset.sdInteractive),namespace:t.dataset.sdNamespace||null}}(t),s=new tn(null===e?t.textContent:e,Object.assign(r,n)),i=s.dom(),a=t.attributes;for(let t=0;t<a.length;++t)i.setAttribute(a[t].nodeName,a[t].nodeValue);return t.parentNode.replaceChild(i,t),s}function at(t,e=null,n={}){let r=null,s=null;if(e&&"object"==typeof e?r=(s=e).code:(s=n,r=e),Array.isArray(t)){const e=Object.assign({},s,{render:!1}),n=t.map(t=>it(t,r,e)).filter(t=>null!==t);return!1!==s.render&&st(n),n}return it(t,r,s)}class ot{constructor(t,e){Array.isArray(e)?this.deltas=e:this.deltas=[0,2*-e/3,-e,2*-e/3,0,2*e/3,e,2*e/3],this.partWidth=t/this.deltas.length}getDelta(t){return this.deltas[t%this.deltas.length]}}class lt{constructor(t){this.svg=t}reset(){}addDefs(){}getBlock(t){return this.blocks[t]||this.blocks[""]}getNote(t){return this.notes[t]||this.notes[""]}getDivider(t){return this.dividers[t]||this.dividers[""]}optionsAttributes(t,e){return function(t,e){const n=Object.assign({},t[""]);return e.forEach(e=>{Object.assign(n,t[e]||{})}),n}(t,e)}renderAgentLine({className:t,options:e,width:n,x:r,y0:s,y1:i}){const a=this.optionsAttributes(this.agentLineAttrs,e);return n>0?this.svg.box(a,{height:i-s,width:n,x:r-n/2,y:s}).addClass(t):this.svg.line(a,{x1:r,x2:r,y1:s,y2:i}).addClass(t)}renderArrowHead(t,{dir:e,height:n,width:r,x:s,y:i}){const a=r*e.dx,o=r*e.dy,l=.5*n*e.dx,h=.5*-n*e.dy;return this.svg.el("none"===t.fill?"polyline":"polygon").attr("points",s+a-h+" "+(i+o-l)+" "+s+" "+i+" "+(s+a+h)+" "+(i+o+l)).attrs(t)}renderTag(t,{height:e,width:n,x:r,y:s}){const{rx:i,ry:a}=t,o=r+n,l=s+e,h="M"+o+" "+s+"L"+o+" "+(l-a)+"L"+(o-i)+" "+l+"L"+r+" "+l,d=this.svg.el("g");return"none"!==t.fill&&d.add(this.svg.el("path").attr("d",h+"L"+r+" "+s).attrs(t).attr("stroke","none")),"none"!==t.stroke&&d.add(this.svg.el("path").attr("d",h).attrs(t).attr("fill","none")),d}renderDB(t,e){const n=t["db-z"];return this.svg.el("g").add(this.svg.box({rx:e.width/2,ry:n},e).attrs(t),this.svg.el("path").attr("d","M"+e.x+" "+(e.y+n)+"a"+e.width/2+" "+n+" 0 0 0 "+e.width+" 0").attrs(t).attr("fill","none"))}renderRef(t,e){return{fill:this.svg.box(t,e).attrs({stroke:"none"}),mask:this.svg.box(t,e).attrs({fill:"#000000",stroke:"none"}),shape:this.svg.box(t,e).attrs({fill:"none"})}}renderFlatConnect(t,e,{x1:n,y1:r,x2:s,y2:i}){return{p1:{x:n,y:r},p2:{x:s,y:i},shape:this.svg.el("path").attr("d",this.svg.patternedLine(t).move(n,r).line(s,i).cap().asPath()).attrs(e)}}renderRevConnect(t,e,{rad:n,x1:r,x2:s,xR:i,y1:a,y2:o}){const l=(o-a)/2,h=this.svg.patternedLine(t).move(r,a).line(i,a);return n<l?h.arc(i,a+n,Math.PI/2).line(i+n,o-n).arc(i,o-n,Math.PI/2):h.arc(i,(a+o)/2,Math.PI),{p1:{x:r,y:a},p2:{x:s,y:o},shape:this.svg.el("path").attr("d",h.line(s,o).cap().asPath()).attrs(e)}}renderLineDivider({lineAttrs:t},{height:e,labelWidth:n,width:r,x:s,y:i}){let a=null;const o=i+e/2;return a=n>0?this.svg.el("g").add(this.svg.line({fill:"none"},{x1:s,x2:s+(r-n)/2,y1:o,y2:o}).attrs(t),this.svg.line({fill:"none"},{x1:s+(r+n)/2,x2:s+r,y1:o,y2:o}).attrs(t)):this.svg.line({fill:"none"},{x1:s,x2:s+r,y1:o,y2:o}).attrs(t),{shape:a}}renderDelayDivider({dotSize:t,gapSize:e},{height:n,width:r,x:s,y:i}){const a=this.svg.el("g");for(let o=0;o+e<=n;o+=t+e)a.add(this.svg.box({fill:"#000000"},{height:e,width:r,x:s,y:i+o}));return{mask:a}}renderTearDivider({fadeBegin:t,fadeSize:e,lineAttrs:n,pattern:r,zigHeight:s,zigWidth:i},{env:a,height:o,labelHeight:l,labelWidth:h,width:d,x:g,y:c}){const u=a.addDef("tear-grad",()=>{const n=100/d;return this.svg.linearGradient({},[{offset:t*n+"%","stop-color":"#000000"},{offset:(t+e)*n+"%","stop-color":"#FFFFFF"},{offset:100-(t+e)*n+"%","stop-color":"#FFFFFF"},{offset:100-t*n+"%","stop-color":"#000000"}])}),p=this.svg.el("mask").attr("maskUnits","userSpaceOnUse").add(this.svg.box({fill:"url(#"+u+")"},{height:o+10,width:d,x:g,y:c-5})),f=a.addDef(p);h>0&&p.add(this.svg.box({fill:"#000000",rx:2,ry:2},{height:l+2,width:h,x:g+(d-h)/2,y:c+(o-l)/2-1}));const m=r||new ot(i,[s,-s]);let b=null;const y=this.svg.patternedLine(m).move(g,c).line(g+d,c),x=this.svg.el("g").attr("mask","url(#"+f+")").add(this.svg.el("path").attrs({d:y.asPath(),fill:"none"}).attrs(n));if(o>0){const t=this.svg.patternedLine(m).move(g,c+o).line(g+d,c+o);x.add(this.svg.el("path").attrs({d:t.asPath(),fill:"none"}).attrs(n)),y.line(t.x,t.y,{patterned:!1}).cap(),y.points.push(...t.points.reverse()),b=this.svg.el("path").attrs({d:y.asPath(),fill:"#000000"})}return{mask:b,shape:x}}}const ht="Helvetica,Arial,Liberation Sans,sans-serif",dt=1.3,gt=new ot(6,.5),ct={"font-family":ht,"font-size":8,"line-height":dt},ut={"font-family":ht,"font-size":8,"line-height":dt,"text-anchor":"middle"};class pt extends lt{constructor(t){super(t);const e={padding:{top:3,bottom:2},tag:{padding:{top:1,left:3,right:3,bottom:0},boxRenderer:this.renderTag.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":1,rx:2,ry:2}),labelAttrs:{"font-family":ht,"font-weight":"bold","font-size":9,"line-height":dt,"text-anchor":"left"}},label:{minHeight:4,padding:{top:1,left:5,right:3,bottom:1},labelAttrs:{"font-family":ht,"font-size":8,"line-height":dt,"text-anchor":"left"}}};Object.assign(this,{titleMargin:10,outerMargin:5,agentMargin:10,actionMargin:10,minActionMargin:3,agentLineHighlightRadius:4,agentCap:{box:{padding:{top:5,left:10,right:10,bottom:5},arrowBottom:12.8,boxAttrs:{fill:"#FFFFFF",stroke:"#000000","stroke-width":1},labelAttrs:{"font-family":ht,"font-size":12,"line-height":dt,"text-anchor":"middle"}},database:{padding:{top:12,left:10,right:10,bottom:3},arrowBottom:12.8,boxRenderer:this.renderDB.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":1,"db-z":5}),labelAttrs:{"font-family":ht,"font-size":12,"line-height":dt,"text-anchor":"middle"}},cross:{size:20,render:t.crossFactory({fill:"none",stroke:"#000000","stroke-width":1})},bar:{height:4,render:t.boxFactory({fill:"#000000",stroke:"#000000","stroke-width":1})},fade:{width:5,height:6,extend:1},none:{height:10}},connect:{loopbackRadius:6,line:{solid:{attrs:{fill:"none",stroke:"#000000","stroke-width":1},renderFlat:this.renderFlatConnect.bind(this,null),renderRev:this.renderRevConnect.bind(this,null)},dash:{attrs:{fill:"none",stroke:"#000000","stroke-width":1,"stroke-dasharray":"4, 2"},renderFlat:this.renderFlatConnect.bind(this,null),renderRev:this.renderRevConnect.bind(this,null)},wave:{attrs:{fill:"none",stroke:"#000000","stroke-width":1,"stroke-linejoin":"round","stroke-linecap":"round"},renderFlat:this.renderFlatConnect.bind(this,gt),renderRev:this.renderRevConnect.bind(this,gt)}},arrow:{single:{width:5,height:10,render:this.renderArrowHead.bind(this),attrs:{fill:"#000000","stroke-width":0,"stroke-linejoin":"miter"}},double:{width:4,height:6,render:this.renderArrowHead.bind(this),attrs:{fill:"none",stroke:"#000000","stroke-width":1,"stroke-linejoin":"miter"}},cross:{short:7,radius:3,render:t.crossFactory({fill:"none",stroke:"#000000","stroke-width":1})}},label:{padding:6,margin:{top:2,bottom:1},attrs:{"font-family":ht,"font-size":8,"line-height":dt,"text-anchor":"middle"},loopbackAttrs:{"font-family":ht,"font-size":8,"line-height":dt}},source:{radius:2,render:t.circleFactory({fill:"#000000",stroke:"#000000","stroke-width":1})},mask:{padding:{top:0,left:3,right:3,bottom:1}}},titleAttrs:{"font-family":ht,"font-size":20,"line-height":dt,"text-anchor":"middle",class:"title"},agentLineAttrs:{"":{fill:"none",stroke:"#000000","stroke-width":1},red:{stroke:"#CC0000"}},blocks:{ref:{margin:{top:0,bottom:0},boxRenderer:this.renderRef.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":1.5,rx:2,ry:2}),section:e},"":{margin:{top:0,bottom:0},boxRenderer:t.boxFactory({fill:"none",stroke:"#000000","stroke-width":1.5,rx:2,ry:2}),collapsedBoxRenderer:this.renderRef.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":1.5,rx:2,ry:2}),section:e,sepRenderer:t.lineFactory({stroke:"#000000","stroke-width":1.5,"stroke-dasharray":"4, 2"})}},notes:{text:{margin:{top:0,left:2,right:2,bottom:0},padding:{top:2,left:2,right:2,bottom:2},overlap:{left:10,right:10},boxRenderer:t.boxFactory({fill:"#FFFFFF"}),labelAttrs:ct},note:{margin:{top:0,left:5,right:5,bottom:0},padding:{top:5,left:5,right:10,bottom:5},overlap:{left:10,right:10},boxRenderer:t.noteFactory({fill:"#FFFFFF",stroke:"#000000","stroke-width":1},{fill:"none",stroke:"#000000","stroke-width":1}),labelAttrs:ct},state:{margin:{top:0,left:5,right:5,bottom:0},padding:{top:7,left:7,right:7,bottom:7},overlap:{left:10,right:10},boxRenderer:t.boxFactory({fill:"#FFFFFF",stroke:"#000000","stroke-width":1,rx:10,ry:10}),labelAttrs:ct}},dividers:{"":{labelAttrs:ut,padding:{top:2,left:5,right:5,bottom:2},extend:0,margin:0,render:()=>({})},line:{labelAttrs:ut,padding:{top:2,left:5,right:5,bottom:2},extend:10,margin:0,render:this.renderLineDivider.bind(this,{lineAttrs:{stroke:"#000000"}})},delay:{labelAttrs:ut,padding:{top:2,left:5,right:5,bottom:2},extend:0,margin:0,render:this.renderDelayDivider.bind(this,{dotSize:1,gapSize:2})},tear:{labelAttrs:ut,padding:{top:2,left:5,right:5,bottom:2},extend:10,margin:10,render:this.renderTearDivider.bind(this,{fadeBegin:5,fadeSize:10,zigWidth:6,zigHeight:1,lineAttrs:{stroke:"#000000"}})}}})}}const ft="Helvetica,Arial,Liberation Sans,sans-serif",mt=1.3,bt=new ot(10,1),yt={"font-family":ft,"font-size":8,"line-height":mt},xt={"font-family":ft,"font-size":8,"line-height":mt,"text-anchor":"middle"};class wt extends lt{constructor(t){super(t);const e={padding:{top:3,bottom:4},tag:{padding:{top:2,left:5,right:5,bottom:1},boxRenderer:this.renderTag.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":2,rx:3,ry:3}),labelAttrs:{"font-family":ft,"font-weight":"bold","font-size":9,"line-height":mt,"text-anchor":"left"}},label:{minHeight:5,padding:{top:2,left:5,right:3,bottom:1},labelAttrs:{"font-family":ft,"font-size":8,"line-height":mt,"text-anchor":"left"}}};Object.assign(this,{titleMargin:12,outerMargin:5,agentMargin:8,actionMargin:5,minActionMargin:5,agentLineHighlightRadius:4,agentCap:{box:{padding:{top:1,left:3,right:3,bottom:1},arrowBottom:11.1,boxAttrs:{fill:"#FFFFFF",stroke:"#000000","stroke-width":3,rx:4,ry:4},labelAttrs:{"font-family":ft,"font-weight":"bold","font-size":14,"line-height":mt,"text-anchor":"middle"}},database:{padding:{top:4,left:3,right:3,bottom:0},arrowBottom:11.1,boxRenderer:this.renderDB.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":3,"db-z":2}),labelAttrs:{"font-family":ft,"font-weight":"bold","font-size":14,"line-height":mt,"text-anchor":"middle"}},cross:{size:20,render:t.crossFactory({fill:"none",stroke:"#000000","stroke-width":3,"stroke-linecap":"round"})},bar:{height:4,render:t.boxFactory({fill:"#000000",stroke:"#000000","stroke-width":3,rx:2,ry:2})},fade:{width:5,height:10,extend:1},none:{height:10}},connect:{loopbackRadius:8,line:{solid:{attrs:{fill:"none",stroke:"#000000","stroke-width":3},renderFlat:this.renderFlatConnect.bind(this,null),renderRev:this.renderRevConnect.bind(this,null)},dash:{attrs:{fill:"none",stroke:"#000000","stroke-width":3,"stroke-dasharray":"10, 4"},renderFlat:this.renderFlatConnect.bind(this,null),renderRev:this.renderRevConnect.bind(this,null)},wave:{attrs:{fill:"none",stroke:"#000000","stroke-width":3,"stroke-linejoin":"round","stroke-linecap":"round"},renderFlat:this.renderFlatConnect.bind(this,bt),renderRev:this.renderRevConnect.bind(this,bt)}},arrow:{single:{width:10,height:12,render:this.renderArrowHead.bind(this),attrs:{fill:"#000000",stroke:"#000000","stroke-width":3,"stroke-linejoin":"round"}},double:{width:10,height:12,render:this.renderArrowHead.bind(this),attrs:{fill:"none",stroke:"#000000","stroke-width":3,"stroke-linejoin":"round","stroke-linecap":"round"}},cross:{short:10,radius:5,render:t.crossFactory({fill:"none",stroke:"#000000","stroke-width":3,"stroke-linejoin":"round","stroke-linecap":"round"})}},label:{padding:7,margin:{top:2,bottom:3},attrs:{"font-family":ft,"font-size":8,"line-height":mt,"text-anchor":"middle"},loopbackAttrs:{"font-family":ft,"font-size":8,"line-height":mt}},source:{radius:5,render:t.circleFactory({fill:"#000000",stroke:"#000000","stroke-width":3})},mask:{padding:{top:1,left:5,right:5,bottom:3}}},titleAttrs:{"font-family":ft,"font-weight":"bolder","font-size":20,"line-height":mt,"text-anchor":"middle",class:"title"},agentLineAttrs:{"":{fill:"none",stroke:"#000000","stroke-width":3},red:{stroke:"#DD0000"}},blocks:{ref:{margin:{top:0,bottom:0},boxRenderer:this.renderRef.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":4,rx:5,ry:5}),section:e},"":{margin:{top:0,bottom:0},boxRenderer:t.boxFactory({fill:"none",stroke:"#000000","stroke-width":4,rx:5,ry:5}),collapsedBoxRenderer:this.renderRef.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":4,rx:5,ry:5}),section:e,sepRenderer:t.lineFactory({stroke:"#000000","stroke-width":2,"stroke-dasharray":"5, 3"})}},notes:{text:{margin:{top:0,left:2,right:2,bottom:0},padding:{top:2,left:2,right:2,bottom:2},overlap:{left:10,right:10},boxRenderer:t.boxFactory({fill:"#FFFFFF"}),labelAttrs:yt},note:{margin:{top:0,left:5,right:5,bottom:0},padding:{top:3,left:3,right:10,bottom:3},overlap:{left:10,right:10},boxRenderer:t.noteFactory({fill:"#FFFFFF",stroke:"#000000","stroke-width":2,"stroke-linejoin":"round"},{fill:"none",stroke:"#000000","stroke-width":1}),labelAttrs:yt},state:{margin:{top:0,left:5,right:5,bottom:0},padding:{top:5,left:7,right:7,bottom:5},overlap:{left:10,right:10},boxRenderer:t.boxFactory({fill:"#FFFFFF",stroke:"#000000","stroke-width":3,rx:10,ry:10}),labelAttrs:yt}},dividers:{"":{labelAttrs:xt,padding:{top:2,left:5,right:5,bottom:2},extend:0,margin:0,render:()=>({})},line:{labelAttrs:xt,padding:{top:2,left:5,right:5,bottom:2},extend:10,margin:0,render:this.renderLineDivider.bind(this,{lineAttrs:{stroke:"#000000","stroke-width":2,"stroke-linecap":"round"}})},delay:{labelAttrs:xt,padding:{top:2,left:5,right:5,bottom:2},extend:0,margin:0,render:this.renderDelayDivider.bind(this,{dotSize:3,gapSize:3})},tear:{labelAttrs:xt,padding:{top:2,left:5,right:5,bottom:2},extend:10,margin:10,render:this.renderTearDivider.bind(this,{fadeBegin:5,fadeSize:10,zigWidth:6,zigHeight:1,lineAttrs:{stroke:"#000000","stroke-width":2,"stroke-linejoin":"round"}})}}})}}class kt{constructor(){this.listeners=new Map,this.forwards=new Set}addEventListener(t,e){const n=this.listeners.get(t);n?n.push(e):this.listeners.set(t,[e])}removeEventListener(t,e){const n=this.listeners.get(t);if(!n)return;const r=n.indexOf(e);-1!==r&&n.splice(r,1)}on(t,e){return this.addEventListener(t,e),this}off(t,e){return this.removeEventListener(t,e),this}countEventListeners(t){return(this.listeners.get(t)||[]).length}removeAllEventListeners(t){t?this.listeners.delete(t):this.listeners.clear()}addEventForwarding(t){this.forwards.add(t)}removeEventForwarding(t){this.forwards.delete(t)}removeAllEventForwardings(){this.forwards.clear()}trigger(t,e=[]){(this.listeners.get(t)||[]).forEach(t=>t(...e)),this.forwards.forEach(n=>n.trigger(t,e))}}const vt="undefined"==typeof window,At=!vt&&/^((?!chrome|android).)*safari/i.test(window.navigator.userAgent),Ft=!vt&&void 0!==window.InstallTrigger;class St{constructor(){this.latestSVG=null,this.latestInternalSVG=null,this.canvas=null,this.context=null,this.indexPNG=0,this.latestPNGIndex=0,this.latestPNG=null}getSVGContent(t){let e=t.dom().outerHTML;return e=e.replace(/^<svg ?/,'<svg width="'+(t.width||1)+'" height="'+(t.height||1)+'" ')}getSVGBlob(t){return new Blob([this.getSVGContent(t)],{type:"image/svg+xml"})}getSVGURL(t){const e=this.getSVGBlob(t);return this.latestSVG&&URL.revokeObjectURL(this.latestSVG),this.latestSVG=URL.createObjectURL(e),this.latestSVG}getCanvas(t,e,n){this.canvas||(window.devicePixelRatio=1,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"));const r=(t.width||1)*e,s=(t.height||1)*e,i=new Image(r,s);let a=null;At&&((a=document.createElement("div")).style.position="absolute",a.style.visibility="hidden",a.appendChild(i),document.body.appendChild(a));const o=()=>{this.canvas.width=r,this.canvas.height=s,this.context.drawImage(i,0,0,r,s),a&&document.body.removeChild(a),n(this.canvas)};i.addEventListener("load",()=>{a?setTimeout(o,50):o()},{once:!0}),i.src=this.getSVGURL(t)}getPNGBlob(t,e,n){this.getCanvas(t,e,t=>{t.toBlob(n,"image/png")})}getPNGURL(t,e,n){++this.indexPNG;const r=this.indexPNG;this.getPNGBlob(t,e,t=>{const e=URL.createObjectURL(t);r>=this.latestPNGIndex?(this.latestPNG&&URL.revokeObjectURL(this.latestPNG),this.latestPNG=e,this.latestPNGIndex=r,n(e,!0)):(n(e,!1),URL.revokeObjectURL(e))})}}class Mt{constructor({visible:t=!1,locked:e=!1,blocked:n=!1,highlighted:r=!1,group:s=null,covered:i=!1}={}){this.visible=t,this.locked=e,this.blocked=n,this.highlighted=r,this.group=s,this.covered=i}}Mt.LOCKED=new Mt({locked:!0}),Mt.DEFAULT=new Mt;const Rt={equals:(t,e)=>t.name===e.name,hasFlag:(t,e=!0)=>n=>n.flags.includes(t)===e},Ct={addNearby:(e,n,r,s)=>{const i=t(e,n,Ct.equals);-1===i?e.push(r):e.splice(i+s,0,r)},equals:(t,e)=>t.id===e.id,hasIntersection:(e,n)=>(function(e,n,r=null){for(let s=0;s<n.length;++s)if(-1!==t(e,n[s],r))return!0;return!1})(e,n,Ct.equals),indexOf:(e,n)=>t(e,n,Ct.equals),make:(t,{anchorRight:e=!1,isVirtualSource:n=!1}={})=>({anchorRight:e,id:t,isVirtualSource:n,options:[]})},It={"note left":[Ct.make("[")],"note over":[Ct.make("["),Ct.make("]")],"note right":[Ct.make("]")]},Et=["[","]"],Gt={"agent begin":{check:["mode"],merge:["agentIDs"],siblings:new Set(["agent highlight"])},"agent end":{check:["mode"],merge:["agentIDs"],siblings:new Set(["agent highlight"])},"agent highlight":{check:["highlighted"],merge:["agentIDs"],siblings:new Set(["agent begin","agent end"])}},Dt=["agent begin","agent end","agent highlight","block begin","block end","connect","connect-delay-begin","connect-delay-end","note over","note right","note left","note between"];class Lt{constructor(){this.agentStates=new Map,this.agentAliases=new Map,this.activeGroups=new Map,this.gAgents=[],this.labelPattern=null,this.nextID=0,this.nesting=[],this.markers=new Set,this.currentSection=null,this.currentNest=null,this.stageHandlers={"agent begin":this.handleAgentBegin.bind(this),"agent define":this.handleAgentDefine.bind(this),"agent end":this.handleAgentEnd.bind(this),"agent options":this.handleAgentOptions.bind(this),async:this.handleAsync.bind(this),"block begin":this.handleBlockBegin.bind(this),"block end":this.handleBlockEnd.bind(this),"block split":this.handleBlockSplit.bind(this),connect:this.handleConnect.bind(this),"connect-delay-begin":this.handleConnectDelayBegin.bind(this),"connect-delay-end":this.handleConnectDelayEnd.bind(this),divider:this.handleDivider.bind(this),"group begin":this.handleGroupBegin.bind(this),"label pattern":this.handleLabelPattern.bind(this),mark:this.handleMark.bind(this),"note between":this.handleNote.bind(this),"note left":this.handleNote.bind(this),"note over":this.handleNote.bind(this),"note right":this.handleNote.bind(this)},this.expandGroupedGAgent=this.expandGroupedGAgent.bind(this),this.handleStage=this.handleStage.bind(this),this.toGAgent=this.toGAgent.bind(this),this.endGroup=this.endGroup.bind(this)}_aliasInUse(t){const e=this.agentAliases.get(t);return!(!e||e===t)||this.gAgents.some(e=>e.id===t)}toGAgent({name:t,alias:e,flags:n}){if(e){if(this.agentAliases.has(t))throw new Error("Cannot alias "+t+"; it is already an alias");if(this._aliasInUse(e))throw new Error("Cannot use "+e+" as an alias; it is already in use");this.agentAliases.set(e,t)}return Ct.make(this.agentAliases.get(t)||t,{isVirtualSource:n.includes("source")})}addStage(t,{isVisible:e=!0,parallel:n=!1}={}){if(!t)return;e&&(this.currentNest.hasContent=!0),void 0===t.ln&&(t.ln=this.latestLine);const{stages:r}=this.currentSection;if(n){const e=s(r),n=p(e,t);if(n)throw new Error(n);const i=this.makeParallel([e,t]);i.ln=t.ln,--r.length,r.push(i)}else r.push(t)}addImpStage(t,{parallel:e=!1}={}){if(!t)return;void 0===t.ln&&(t.ln=this.latestLine);const{stages:n}=this.currentSection;if(e){const e=n[n.length-2];if(0===n.length)throw new Error("Nothing to run statement in parallel with");if(p(e,t))n.splice(n.length-1,0,t);else{const r=this.makeParallel([e,t]);r.ln=t.ln,n.splice(n.length-2,1,r)}}else n.push(t)}makeParallel(t){const e=[];return u(e,t),0===e.length?null:1===e.length?e[0]:(e.forEach(t=>{void 0===t.ln&&(t.ln=this.latestLine)}),{stages:e,type:"parallel"})}defineGAgents(t){e(this.currentNest.gAgents,t.filter(t=>!Et.includes(t.id)),Ct.equals),e(this.gAgents,t,Ct.equals)}getGAgentState(t){return this.agentStates.get(t.id)||Mt.DEFAULT}updateGAgentState(t,e){const n=this.agentStates.get(t.id);n?Object.assign(n,e):this.agentStates.set(t.id,new Mt(e))}replaceGAgentState(t,e){this.agentStates.set(t.id,e)}validateGAgents(t,{allowGrouped:e=!1,allowCovered:n=!1,allowVirtual:r=!1}={}){t.forEach(t=>{const s=this.getGAgentState(t),i=t.id;if(function(t){return t.blocked&&null===t.group}(s))throw new Error("Duplicate agent name: "+i);if(!n&&s.covered)throw new Error("Agent "+i+" is hidden behind group");if(!e&&null!==s.group)throw new Error("Agent "+i+" is in a group");if(!r&&t.isVirtualSource)throw new Error("Cannot use message source here");if(function(t){return t.startsWith("__")}(i))throw new Error(i+" is a reserved name")})}setGAgentVis(t,e,n,r=!1){const s=new Set,i=t.filter(t=>{if(s.has(t.id))return!1;s.add(t.id);const n=this.getGAgentState(t);if(n.locked||n.blocked){if(r)throw new Error("Cannot begin/end agent: "+t.id);return!1}return n.visible!==e});return 0===i.length?null:(i.forEach(t=>{this.updateGAgentState(t,{visible:e})}),this.defineGAgents(i),{agentIDs:i.map(t=>t.id),mode:n,type:e?"agent begin":"agent end"})}setGAgentHighlight(t,e,n=!1){const r=t.filter(t=>{const r=this.getGAgentState(t);if(r.locked||r.blocked){if(n)throw new Error("Cannot highlight agent: "+t.id);return!1}return r.visible&&r.highlighted!==e});return 0===r.length?null:(r.forEach(t=>{this.updateGAgentState(t,{highlighted:e})}),{agentIDs:r.map(t=>t.id),highlighted:e,type:"agent highlight"})}_makeSection(t,e){return{delayedConnections:new Map,header:t,stages:e}}_checkSectionEnd(){const t=this.currentSection.delayedConnections;if(t.size>0){const e=t.values().next().value;throw new Error('Unused delayed connection "'+e.tag+'" at line '+(e.ln+1))}}beginNested(t,{tag:e,label:n,name:r,ln:s}){const i=Ct.make(r+"[",{anchorRight:!0}),a=Ct.make(r+"]"),o=[i,a],l=[];return this.currentSection=this._makeSection({blockType:t,canHide:!0,label:this.textFormatter(n),left:i.id,ln:s,right:a.id,tag:this.textFormatter(e),type:"block begin"},l),this.currentNest={blockType:t,gAgents:o,hasContent:!1,leftGAgent:i,rightGAgent:a,sections:[this.currentSection]},this.replaceGAgentState(i,Mt.LOCKED),this.replaceGAgentState(a,Mt.LOCKED),this.nesting.push(this.currentNest),{stages:l}}nextBlockName(){const t="__BLOCK"+this.nextID;return++this.nextID,t}nextVirtualAgentName(){const t="__"+this.nextID;return++this.nextID,t}handleBlockBegin({ln:t,blockType:e,tag:n,label:r,parallel:s}){if(s)throw new Error("Cannot use parallel here");this.beginNested(e,{label:r,ln:t,name:this.nextBlockName(),tag:n})}handleBlockSplit({ln:t,blockType:e,tag:n,label:r,parallel:s}){if(s)throw new Error("Cannot use parallel here");if("if"!==this.currentNest.blockType)throw new Error('Invalid block nesting ("else" inside '+this.currentNest.blockType+")");this._checkSectionEnd(),this.currentSection=this._makeSection({blockType:e,label:this.textFormatter(r),left:this.currentNest.leftGAgent.id,ln:t,right:this.currentNest.rightGAgent.id,tag:this.textFormatter(n),type:"block split"},[]),this.currentNest.sections.push(this.currentSection)}handleBlockEnd({parallel:t}){if(this.nesting.length<=1)throw new Error('Invalid block nesting (too many "end"s)');this._checkSectionEnd();const e=this.nesting.pop();if(this.currentNest=s(this.nesting),this.currentSection=s(this.currentNest.sections),!e.hasContent)throw new Error("Empty block");this.defineGAgents(e.gAgents),m(this.gAgents,e.leftGAgent,e.rightGAgent,e.gAgents),e.sections.forEach(t=>{this.currentSection.stages.push(t.header),this.currentSection.stages.push(...t.stages)}),this.addStage({left:e.leftGAgent.id,right:e.rightGAgent.id,type:"block end"},{parallel:t})}makeGroupDetails(t,e){const r=t.map(this.toGAgent);if(this.validateGAgents(r),this.agentStates.has(e))throw new Error("Duplicate agent name: "+e);const s=this.nextBlockName(),i=Ct.make(s+"[",{anchorRight:!0}),a=Ct.make(s+"]");this.replaceGAgentState(i,Mt.LOCKED),this.replaceGAgentState(a,Mt.LOCKED),this.updateGAgentState(Ct.make(e),{blocked:!0,group:e}),this.defineGAgents([...r,i,a]);const{indexL:o,indexR:l}=m(this.gAgents,i,a,r),h=[],d=r.slice();for(let t=o+1;t<l;++t)h.push(this.gAgents[t]);return n(h,d,Ct.equals),{gAgents:r,gAgentsContained:d,gAgentsCovered:h,leftGAgent:i,rightGAgent:a}}handleGroupBegin({agents:t,blockType:e,tag:n,label:r,alias:s,parallel:i}){const a=this.makeGroupDetails(t,s);a.gAgentsContained.forEach(t=>{this.updateGAgentState(t,{group:s})}),a.gAgentsCovered.forEach(t=>{this.updateGAgentState(t,{covered:!0})}),this.activeGroups.set(s,a),this.addImpStage(this.setGAgentVis(a.gAgents,!0,"box"),{parallel:i}),this.addStage({blockType:e,canHide:!1,label:this.textFormatter(r),left:a.leftGAgent.id,right:a.rightGAgent.id,tag:this.textFormatter(n),type:"block begin"},{parallel:i})}endGroup({name:t}){const e=this.activeGroups.get(t);return e?(this.activeGroups.delete(t),e.gAgentsContained.forEach(t=>{this.updateGAgentState(t,{group:null})}),e.gAgentsCovered.forEach(t=>{this.updateGAgentState(t,{covered:!1})}),this.updateGAgentState(Ct.make(t),{group:null}),{left:e.leftGAgent.id,right:e.rightGAgent.id,type:"block end"}):null}handleMark({name:t,parallel:e}){this.markers.add(t),this.addStage({name:t,type:"mark"},{isVisible:!1,parallel:e})}handleDivider({mode:t,height:e,label:n,parallel:r}){this.addStage({formattedLabel:this.textFormatter(n),height:e,mode:t,type:"divider"},{isVisible:!1,parallel:r})}handleAsync({target:t,parallel:e}){if(""!==t&&!this.markers.has(t))throw new Error("Unknown marker: "+t);this.addStage({target:t,type:"async"},{isVisible:!1,parallel:e})}handleLabelPattern({pattern:t}){this.labelPattern=t.slice();for(let t=0;t<this.labelPattern.length;++t){const e=this.labelPattern[t];"object"==typeof e&&void 0!==e.start&&(this.labelPattern[t]=Object.assign({current:e.start},e))}}applyLabelPattern(t){let e="";const n={label:t};return this.labelPattern.forEach(t=>{"string"==typeof t?e+=t:void 0!==t.token?e+=n[t.token]:void 0!==t.current&&(e+=t.current.toFixed(t.dp),t.current+=t.inc)}),e}expandGroupedGAgent(t){const{group:e}=this.getGAgentState(t);if(!e)return[t];const n=this.activeGroups.get(e);return[n.leftGAgent,n.rightGAgent]}expandGroupedGAgentConnection(t){const e=this.expandGroupedGAgent(t[0]),n=this.expandGroupedGAgent(t[1]);let r=Ct.indexOf(this.gAgents,e[0]),i=Ct.indexOf(this.gAgents,n[0]);return-1===r&&(r=e[0].isVirtualSource?-1:this.gAgents.length),-1===i&&(i=this.gAgents.length),r===i?[s(e),s(n)]:r<i?[s(e),n[0]]:[e[0],s(n)]}filterConnectFlags(t){const n=t.filter(Rt.hasFlag("begin")).map(this.toGAgent),r=t.filter(Rt.hasFlag("end")).map(this.toGAgent);if(Ct.hasIntersection(n,r))throw new Error("Cannot set agent visibility multiple times");const s=t.filter(Rt.hasFlag("start")).map(this.toGAgent),i=t.filter(Rt.hasFlag("stop")).map(this.toGAgent);if(e(i,r),Ct.hasIntersection(s,i))throw new Error("Cannot set agent highlighting multiple times");return this.validateGAgents(n),this.validateGAgents(r),this.validateGAgents(s),this.validateGAgents(i),{beginGAgents:n,endGAgents:r,startGAgents:s,stopGAgents:i}}makeVirtualAgent(t){const e=Ct.make(this.nextVirtualAgentName(),{anchorRight:t,isVirtualSource:!0});return this.replaceGAgentState(e,Mt.LOCKED),e}addNearbyAgent(t,e,n){Ct.addNearby(this.currentNest.gAgents,t,e,n),Ct.addNearby(this.gAgents,t,e,n)}expandVirtualSourceAgents(t){if(t[0].isVirtualSource){if(t[1].isVirtualSource)throw new Error("Cannot connect found messages");if(Et.includes(t[1].id))throw new Error("Cannot connect found messages to special agents");const e=this.makeVirtualAgent(!0);return this.addNearbyAgent(t[1],e,0),[e,t[1]]}if(t[1].isVirtualSource){if(Et.includes(t[0].id))throw new Error("Cannot connect found messages to special agents");const e=this.makeVirtualAgent(!1);return this.addNearbyAgent(t[0],e,1),[t[0],e]}return t}_handlePartialConnect(t,e){const n=this.filterConnectFlags(t),r=t.map(this.toGAgent);this.validateGAgents(r,{allowGrouped:!0,allowVirtual:!0}),this.defineGAgents(a(r,this.expandGroupedGAgent).filter(t=>!t.isVirtualSource));const s=t.filter(Rt.hasFlag("begin",!1)).map(this.toGAgent).filter(t=>!t.isVirtualSource);return this.addImpStage(this.setGAgentVis(s,!0,"box"),{parallel:e}),{flags:n,gAgents:r}}_makeConnectParallelStages(t,e){return this.makeParallel([this.setGAgentVis(t.beginGAgents,!0,"box",!0),this.setGAgentHighlight(t.startGAgents,!0,!0),e,this.setGAgentHighlight(t.stopGAgents,!1,!0),this.setGAgentVis(t.endGAgents,!1,"cross",!0)])}_isSelfConnect(t){const e=t.map(this.toGAgent),n=this.expandGroupedGAgentConnection(e);return n[0].id===n[1].id&&!n.some(t=>t.isVirtualSource)}handleConnect({agents:t,label:e,options:n,parallel:r}){if(this._isSelfConnect(t)){const s={};return this.handleConnectDelayBegin({agent:t[0],ln:0,options:n,tag:s,parallel:r}),void this.handleConnectDelayEnd({agent:t[1],label:e,options:n,tag:s})}let{flags:s,gAgents:i}=this._handlePartialConnect(t,r);i=this.expandGroupedGAgentConnection(i);const a={agentIDs:(i=this.expandVirtualSourceAgents(i)).map(t=>t.id),label:this.textFormatter(this.applyLabelPattern(e)),options:n,type:"connect"};this.addStage(this._makeConnectParallelStages(s,a),{parallel:r})}handleConnectDelayBegin({agent:t,tag:e,options:n,ln:r,parallel:s}){const i=this.currentSection.delayedConnections;if(i.has(e))throw new Error('Duplicate delayed connection "'+e+'"');const{flags:a,gAgents:o}=this._handlePartialConnect([t],s),l=this.nextVirtualAgentName(),h={agentIDs:null,label:null,options:n,tag:l,type:"connect-delay-begin"};i.set(e,{connectStage:h,gAgents:o,ln:r,tag:e,uniqueTag:l}),this.addStage(this._makeConnectParallelStages(a,h),{parallel:s})}handleConnectDelayEnd({agent:t,tag:e,label:n,options:r,parallel:s}){const i=this.currentSection.delayedConnections,a=i.get(e);if(!a)throw new Error('Unknown delayed connection "'+e+'"');let{flags:o,gAgents:l}=this._handlePartialConnect([t],s);l=this.expandGroupedGAgentConnection([...a.gAgents,...l]),l=this.expandVirtualSourceAgents(l);let h=a.connectStage.options;if(h.line!==r.line)throw new Error("Mismatched delayed connection arrows");r.right&&(h=Object.assign({},h,{right:r.right})),Object.assign(a.connectStage,{agentIDs:l.map(t=>t.id),label:this.textFormatter(this.applyLabelPattern(n)),options:h});const d={tag:a.uniqueTag,type:"connect-delay-end"};this.addStage(this._makeConnectParallelStages(o,d),{parallel:s}),i.delete(e)}handleNote({type:t,agents:e,mode:n,label:r,parallel:s}){let i=null;i=0===e.length?It[t]||[]:e.map(this.toGAgent),this.validateGAgents(i,{allowGrouped:!0});const o=(i=a(i,this.expandGroupedGAgent)).map(t=>t.id),l=new Set(o).size;if("note between"===t&&l<2)throw new Error("note between requires at least 2 agents");this.defineGAgents(i),this.addImpStage(this.setGAgentVis(i,!0,"box"),{parallel:s}),this.addStage({agentIDs:o,label:this.textFormatter(r),mode:n,type:t},{parallel:s})}handleAgentDefine({agents:t}){const n=t.map(this.toGAgent);this.validateGAgents(n,{allowCovered:!0,allowGrouped:!0}),e(this.gAgents,n,Ct.equals)}handleAgentOptions({agent:t,options:n}){const r=this.toGAgent(t),s=[r];this.validateGAgents(s,{allowCovered:!0,allowGrouped:!0}),e(this.gAgents,s,Ct.equals),this.gAgents.filter(({id:t})=>t===r.id).forEach(t=>{e(t.options,n)})}handleAgentBegin({agents:t,mode:e,parallel:n}){const r=t.map(this.toGAgent);this.validateGAgents(r),this.addStage(this.setGAgentVis(r,!0,e,!0),{parallel:n})}handleAgentEnd({agents:t,mode:e,parallel:n}){const r=t.filter(t=>this.activeGroups.has(t.name)),s=t.filter(t=>!this.activeGroups.has(t.name)).map(this.toGAgent);this.validateGAgents(s),this.addStage(this.makeParallel([this.setGAgentHighlight(s,!1),this.setGAgentVis(s,!1,e,!0),...r.map(this.endGroup)]),{parallel:n})}handleStage(t){this.latestLine=t.ln;try{const e=this.stageHandlers[t.type];if(!e)throw new Error("Unknown command: "+t.type);e(t)}catch(e){if("object"==typeof e&&e.message)throw e.message+=" at line "+(t.ln+1),e}}_reset(){this.agentStates.clear(),this.markers.clear(),this.agentAliases.clear(),this.activeGroups.clear(),this.gAgents.length=0,this.nextID=0,this.nesting.length=0,this.labelPattern=[{token:"label"}]}_finalise(t){m(this.gAgents,this.currentNest.leftGAgent,this.currentNest.rightGAgent),function(t){let e=[],n=new Set;for(let r=0;r<t.length;){const s=t[r];let i=null;d(i="parallel"===s.type?s.stages:[s]);const a=g(i);c(n,a,e,i),0===i.length?t.splice(r,1):("parallel"===s.type&&1===i.length&&t.splice(r,1,i[0]),n=a,e=i,++r)}}(t.stages),this.gAgents.forEach(t=>{t.formattedLabel=this.textFormatter(t.id)})}generate({stages:t,meta:e={}}){this._reset(),this.textFormatter=e.textFormatter;const n=this.beginNested("global",{label:"",ln:0,name:"",tag:""});if(t.forEach(this.handleStage),1!==this.nesting.length)throw new Error("Unterminated section at line "+(this.currentSection.header.ln+1));if(this.activeGroups.size>0)throw new Error("Unterminated group");this._checkSectionEnd();const r=e.terminators||"none";return this.addStage(this.makeParallel([this.setGAgentHighlight(this.gAgents,!1),this.setGAgentVis(this.gAgents,!1,r)])),this._finalise(n),function(t,e){for(let n=0;n<t.length&&!f(t[n],e);++n);}(n.stages,e.headers||"box"),{agents:this.gAgents.slice(),meta:{code:e.code,theme:e.theme,title:this.textFormatter(e.title)},stages:n.stages}}}const Nt="Courier New,Liberation Mono,monospace",Ot=1.3,zt=new ot(6,[0,-.25,-.5,-.25,0,.25,.5,.25]),Vt={"font-family":Nt,"font-size":8,"line-height":Ot},Bt={"font-family":Nt,"font-size":8,"line-height":Ot,"text-anchor":"middle"};class Tt extends lt{constructor(t){super(t);const e={padding:{top:3,bottom:2},tag:{padding:{top:2,left:4,right:4,bottom:2},boxRenderer:this.renderTag.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":1,rx:3,ry:3}),labelAttrs:{"font-family":Nt,"font-weight":"bold","font-size":9,"line-height":Ot,"text-anchor":"left"}},label:{minHeight:8,padding:{top:2,left:8,right:8,bottom:2},labelAttrs:{"font-family":Nt,"font-size":8,"line-height":Ot,"text-anchor":"left"}}};Object.assign(this,{titleMargin:8,outerMargin:4,agentMargin:12,actionMargin:12,minActionMargin:4,agentLineHighlightRadius:4,agentCap:{box:{padding:{top:4,left:8,right:8,bottom:4},arrowBottom:12,boxAttrs:{fill:"#FFFFFF",stroke:"#000000","stroke-width":1},labelAttrs:{"font-family":Nt,"font-size":12,"line-height":Ot,"text-anchor":"middle"}},database:{padding:{top:9,left:8,right:8,bottom:3},arrowBottom:12,boxRenderer:this.renderDB.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":1,"db-z":4}),labelAttrs:{"font-family":Nt,"font-size":12,"line-height":Ot,"text-anchor":"middle"}},cross:{size:16,render:t.crossFactory({fill:"none",stroke:"#000000","stroke-width":1})},bar:{height:4,render:t.boxFactory({fill:"#000000",stroke:"#000000","stroke-width":1})},fade:{width:5,height:8,extend:1},none:{height:8}},connect:{loopbackRadius:4,line:{solid:{attrs:{fill:"none",stroke:"#000000","stroke-width":1},renderFlat:this.renderFlatConnect.bind(this,null),renderRev:this.renderRevConnect.bind(this,null)},dash:{attrs:{fill:"none",stroke:"#000000","stroke-width":1,"stroke-dasharray":"4, 4"},renderFlat:this.renderFlatConnect.bind(this,null),renderRev:this.renderRevConnect.bind(this,null)},wave:{attrs:{fill:"none",stroke:"#000000","stroke-width":1},renderFlat:this.renderFlatConnect.bind(this,zt),renderRev:this.renderRevConnect.bind(this,zt)}},arrow:{single:{width:4,height:8,render:this.renderArrowHead.bind(this),attrs:{fill:"#000000","stroke-width":0,"stroke-linejoin":"miter"}},double:{width:3,height:6,render:this.renderArrowHead.bind(this),attrs:{fill:"none",stroke:"#000000","stroke-width":1,"stroke-linejoin":"miter"}},cross:{short:8,radius:4,render:t.crossFactory({fill:"none",stroke:"#000000","stroke-width":1})}},label:{padding:4,margin:{top:2,bottom:1},attrs:{"font-family":Nt,"font-size":8,"line-height":Ot,"text-anchor":"middle"},loopbackAttrs:{"font-family":Nt,"font-size":8,"line-height":Ot}},source:{radius:2,render:t.circleFactory({fill:"#000000",stroke:"#000000","stroke-width":1})},mask:{padding:{top:0,left:3,right:3,bottom:1}}},titleAttrs:{"font-family":Nt,"font-size":20,"line-height":Ot,"text-anchor":"middle",class:"title"},agentLineAttrs:{"":{fill:"none",stroke:"#000000","stroke-width":1},red:{stroke:"#AA0000"}},blocks:{ref:{margin:{top:0,bottom:0},boxRenderer:this.renderRef.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":2}),section:e},"":{margin:{top:0,bottom:0},boxRenderer:t.boxFactory({fill:"none",stroke:"#000000","stroke-width":2}),collapsedBoxRenderer:this.renderRef.bind(this,{fill:"#FFFFFF",stroke:"#000000","stroke-width":2}),section:e,sepRenderer:t.lineFactory({stroke:"#000000","stroke-width":2,"stroke-dasharray":"8, 4"})}},notes:{text:{margin:{top:0,left:8,right:8,bottom:0},padding:{top:4,left:4,right:4,bottom:4},overlap:{left:8,right:8},boxRenderer:t.boxFactory({fill:"#FFFFFF"}),labelAttrs:Vt},note:{margin:{top:0,left:8,right:8,bottom:0},padding:{top:8,left:8,right:8,bottom:8},overlap:{left:8,right:8},boxRenderer:t.noteFactory({fill:"#FFFFFF",stroke:"#000000","stroke-width":1},{fill:"none",stroke:"#000000","stroke-width":1}),labelAttrs:Vt},state:{margin:{top:0,left:8,right:8,bottom:0},padding:{top:8,left:8,right:8,bottom:8},overlap:{left:8,right:8},boxRenderer:t.boxFactory({fill:"#FFFFFF",stroke:"#000000","stroke-width":1,rx:8,ry:8}),labelAttrs:Vt}},dividers:{"":{labelAttrs:Bt,padding:{top:2,left:5,right:5,bottom:2},extend:0,margin:0,render:()=>({})},line:{labelAttrs:Bt,padding:{top:2,left:5,right:5,bottom:2},extend:8,margin:0,render:this.renderLineDivider.bind(this,{lineAttrs:{stroke:"#000000"}})},delay:{labelAttrs:Bt,padding:{top:2,left:5,right:5,bottom:2},extend:0,margin:0,render:this.renderDelayDivider.bind(this,{dotSize:2,gapSize:2})},tear:{labelAttrs:Bt,padding:{top:2,left:5,right:5,bottom:2},extend:8,margin:8,render:this.renderTearDivider.bind(this,{fadeBegin:4,fadeSize:4,zigWidth:4,zigHeight:1,lineAttrs:{stroke:"#000000"}})}}})}}const Ht={type:"error line-error",suggest:[],then:{"":0}},Pt=["database","red"],jt=["begin","end","note","state","text"],qt=(()=>{function t(t,e=1){return{type:"variable",suggest:[{known:"Agent"}],then:Object.assign({},t,{"":0,",":{type:"operator",then:{"":e}}})}}function e(t){return{type:"keyword",suggest:[t+" of ",t+": "],then:{of:{type:"keyword",then:{"":l}},":":{type:"operator",then:{"":i}},"":l}}}function n({exit:t,sourceExit:e,blankExit:n}){const r={type:"operator",then:{"+":Ht,"-":Ht,"*":Ht,"!":Ht,"":t}};return{"+":{type:"operator",then:{"+":Ht,"-":Ht,"*":r,"!":Ht,"":t}},"-":{type:"operator",then:{"+":Ht,"-":Ht,"*":r,"!":{type:"operator",then:{"+":Ht,"-":Ht,"*":Ht,"!":Ht,"":t}},"":t}},"*":{type:"operator",then:Object.assign({"+":r,"-":r,"*":Ht,"!":Ht,"":t},e||t)},"!":r,"":n||t}}const r={type:"",suggest:["\n"],then:{}},s={type:"",suggest:[],then:{}},i=b({"\n":r}),a={type:"operator",then:{"":i,"\n":s}},o=t({"\n":r,as:{type:"keyword",then:{"":{type:"variable",suggest:[{known:"Agent"}],then:{"":0,",":{type:"operator",then:{"":3}},"\n":r}}}}}),l=t({":":a}),h={type:"variable",suggest:[{known:"Agent"}],then:{"":0,":":{type:"operator",then:{"":i,"\n":s}},"\n":r}},d={":":{type:"operator",then:{"":b({as:{type:"keyword",then:{"":{type:"variable",suggest:[{known:"Agent"}],then:{"":0,"\n":r}}}}})}}},g={type:"keyword",then:Object.assign({over:{type:"keyword",then:{"":t(d)}}},d)},c={"\n":r,":":{type:"operator",then:{"":i,"\n":s}},with:{type:"keyword",suggest:["with height "],then:{height:{type:"keyword",then:{"":{type:"number",suggest:["6 ","30 "],then:{"\n":r,":":{type:"operator",then:{"":i,"\n":s}}}}}}}}},u=function(t,e,n){const r=Object.assign({},n);return e.forEach(e=>{r[e]={type:t,then:n}}),r}("keyword",["a","an"],function(t,e,n){const r={},s=Object.assign({},n);return e.forEach(e=>{r[e]={type:t,then:s},s[e]=0}),r}("keyword",Pt,{"\n":r})),p={type:"keyword",then:{"":i,":":{type:"operator",then:{"":i}},"\n":r}},f={title:{type:"keyword",then:{"":i}},theme:{type:"keyword",then:{"":{type:"string",suggest:[{global:"themes",suffix:"\n"}],then:{"":0,"\n":r}}}},headers:{type:"keyword",then:{none:{type:"keyword",then:{}},cross:{type:"keyword",then:{}},box:{type:"keyword",then:{}},fade:{type:"keyword",then:{}},bar:{type:"keyword",then:{}}}},terminators:{type:"keyword",then:{none:{type:"keyword",then:{}},cross:{type:"keyword",then:{}},box:{type:"keyword",then:{}},fade:{type:"keyword",then:{}},bar:{type:"keyword",then:{}}}},divider:{type:"keyword",then:Object.assign({line:{type:"keyword",then:c},space:{type:"keyword",then:c},delay:{type:"keyword",then:c},tear:{type:"keyword",then:c}},c)},define:{type:"keyword",then:{"":o,as:Ht}},begin:{type:"keyword",then:{"":o,reference:g,as:Ht}},end:{type:"keyword",then:{"":o,as:Ht,"\n":r}},if:p,else:{type:"keyword",suggest:["else\n","else if: "],then:{if:{type:"keyword",suggest:["if: "],then:{"":i,":":{type:"operator",then:{"":i}}}},"\n":r}},repeat:p,group:p,note:{type:"keyword",then:{over:{type:"keyword",then:{"":l}},left:e("left"),right:e("right"),between:{type:"keyword",then:{"":t({":":Ht},l)}}}},state:{type:"keyword",suggest:["state over "],then:{over:{type:"keyword",then:{"":{type:"variable",suggest:[{known:"Agent"}],then:{"":0,",":Ht,":":a}}}}}},text:{type:"keyword",then:{left:e("left"),right:e("right")}},autolabel:{type:"keyword",then:{off:{type:"keyword",then:{}},"":b({"\n":r},[{v:"<label>",suffix:"\n",q:!0},{v:"[<inc>] <label>",suffix:"\n",q:!0},{v:"[<inc 1,0.01>] <label>",suffix:"\n",q:!0}])}},simultaneously:{type:"keyword",then:{":":{type:"operator",then:{}},with:{type:"keyword",then:{"":{type:"variable",suggest:[{known:"Label"}],then:{"":0,":":{type:"operator",then:{}}}}}}}}};return t=>{const e=function(t){const e={type:"keyword",then:Object.assign({},n({exit:h,sourceExit:{":":a,"\n":s}}),{"...":{type:"operator",then:{"":{type:"variable",suggest:[{known:"DelayedAgent"}],then:{"":0,":":Ht,"\n":r}}}}})},i={};t.forEach(t=>i[t]=e);const o={type:"operator",suggest:[],override:"Label",then:{}},l={type:"variable",suggest:[{known:"Agent"}],then:Object.assign({"":0},i,{":":{type:"operator",override:"Label",then:{}}})},d={type:"variable",suggest:[{known:"DelayedAgent"}],then:Object.assign({"":0,":":o},i)},g=Object.assign({},l,{then:Object.assign({},l.then,{is:{type:"keyword",then:u}})});return Object.assign({"...":{type:"operator",then:{"":d}}},n({exit:l,sourceExit:Object.assign({"":l,":":o},i),blankExit:g}))}(t),i={};for(const t of jt)i[t]=f[t];return Object.assign(i,e),{type:"error line-error",then:Object.assign({},f,{"&":{type:"keyword",then:i}},e)}}})(),Yt=-1;class Ut{constructor(t,e){this.tokenDefinitions=t,this.commands=qt(e),this.lineComment="#"}startState(){return{beginCompletions:w({},[this.commands]),completions:[],current:"",currentQuoted:!1,currentSpace:"",currentType:Yt,indent:0,isVar:!0,knownAgent:[],knownDelayedAgent:[],knownLabel:[],line:[],nextCompletions:[],valid:!0}}_matchPattern(t,e,n){return e?(e.lastIndex=0,t.match(e,n)):null}_tokenBegin(t,e){e.currentSpace="";for(let n="";!t.eol();n=t.next()){e.currentSpace+=n;for(let n=0;n<this.tokenDefinitions.length;++n){const r=this.tokenDefinitions[n];if(this._matchPattern(t,r.start,!0)){e.currentType=n;const{value:t,quoted:s}=A(r);return e.current=t,e.currentQuoted=s,!0}}}return!1}_tokenCheckEscape(t,e,n){const r=this._matchPattern(t,n.escape,!0);r&&(e.current+=n.escapeWith(r))}_addToken(t){t.line.push({q:t.currentQuoted,s:t.currentSpace,v:t.current})}_tokenEndFound(t,e,n,r){return e.currentType=Yt,n.includeEnd&&(e.current+=r[0]),n.omit?"comment":(this._addToken(e),v(e,t.eol(),this.commands))}_tokenEOLFound(t,e,n){if(e.current+="\n",n.omit)return"comment";this._addToken(e);const r=v(e,!1,this.commands);return e.line.pop(),r}_tokenEnd(t,e){for(;;){const n=this.tokenDefinitions[e.currentType];if(this._tokenCheckEscape(t,e,n),!n.end)return this._tokenEndFound(t,e,n,null);{const r=this._matchPattern(t,n.end,!0);if(r)return this._tokenEndFound(t,e,n,r)}if(t.eol())return this._tokenEOLFound(t,e,n);e.current+=t.next()}}_tokenContinueOrBegin(t,e){return e.currentType!==Yt||(t.sol()&&(e.line.length=0,e.valid=!0),this._tokenBegin(t,e))?this._tokenEnd(t,e):""}_isLineTerminated(t){return t.currentType!==Yt||t.valid}token(t,e){e.completions=e.nextCompletions,e.isVar=!0;const n=this._tokenContinueOrBegin(t,e);return t.eol()&&!this._isLineTerminated(e)?"line-error "+n:n}indent(t){return t.indent}}const Wt=[{end:/(?=\n)|$/y,omit:!0,start:/#/y},{baseToken:{q:!0},end:/"/y,escape:/\\(.)/y,escapeWith:function(t){return"n"===t[1]?"\n":t[1]},start:/"/y},{baseToken:{v:"..."},start:/\.\.\./y},{end:/(?=[ \t\r\n:+~\-*!<>,])|$/y,start:/(?=[^ \t\r\n:+~\-*!<>,])/y},{end:/(?=[^~\-<>x])|[-~]x|[<>](?=x)|$/y,includeEnd:!0,start:/(?=[~\-<])/y},{baseToken:{v:","},start:/,/y},{baseToken:{v:":"},start:/:/y},{baseToken:{v:"!"},start:/!/y},{baseToken:{v:"+"},start:/\+/y},{baseToken:{v:"*"},start:/\*/y},{baseToken:{v:"\n"},start:/\n/y}];class Xt{constructor(t){this.src=t,this.block=null,this.token=null,this.pos={ch:0,i:0,ln:0},this.reset()}isOver(){return this.pos.i>this.src.length}reset(){this.token={b:null,e:null,q:!1,s:"",v:""},this.block=null}beginToken(t){this.block=t.newBlock,Object.assign(this.token,this.block.baseToken),this.token.b=M(this.pos)}endToken(){let t=null;return this.block.omit||(this.token.e=M(this.pos),t=this.token),this.reset(),t}advance(){const t=S(this.src,this.pos.i,this.block);return t.newBlock&&this.beginToken(t),this.token.s+=t.appendSpace,this.token.v+=t.appendValue,function(t,e,n){for(let r=0;r<n;++r)++t.ch,"\n"===e[t.i+r]&&(++t.ln,t.ch=0);t.i+=n}(this.pos,this.src,t.skip),t.end?this.endToken():null}}const Qt=/(.*?)<([^<>]*)>/g,Jt=/\.([0-9]*)/,Zt=[{attrs:{"font-style":"italic"},begin:/[\s_~`]\*(?=\S)/g,end:/\S\*(?=[\s_~`])/g},{attrs:{"font-style":"italic"},begin:/[\s*~`]_(?=\S)/g,end:/\S_(?=[\s*~`])/g},{attrs:{"font-weight":"bolder"},begin:/[\s_~`]\*\*(?=\S)/g,end:/\S\*\*(?=[\s_~`])/g},{attrs:{"font-weight":"bolder"},begin:/[\s*~`]__(?=\S)/g,end:/\S__(?=[\s*~`])/g},{attrs:{"text-decoration":"line-through"},begin:/[\s_*`]~(?=\S)/g,end:/\S~(?=[\s_*`])/g},{attrs:{"font-family":"Courier New,Liberation Mono,monospace"},begin:/[\s_*~.]`(?=\S)/g,end:/\S`(?=[\s_*~.])/g}],Kt=new Map;Kt.set("if",{blockType:"if",skip:[],tag:"if",type:"block begin"}),Kt.set("else",{blockType:"else",skip:["if"],tag:"else",type:"block split"}),Kt.set("repeat",{blockType:"repeat",skip:[],tag:"repeat",type:"block begin"}),Kt.set("group",{blockType:"group",skip:[],tag:"",type:"block begin"});const _t={agentFlags:{"!":{flag:"end"},"*":{allowBlankName:!0,blankNameFlag:"source",flag:"begin"},"+":{flag:"start"},"-":{flag:"stop"}},types:(()=>{const t=function(t){const e=[];return i(t,0,[],e),e}([[{tok:"",type:0},{tok:"<",type:1},{tok:"<<",type:2}],[{tok:"-",type:"solid"},{tok:"--",type:"dash"},{tok:"~",type:"wave"}],[{tok:"",type:0},{tok:">",type:1},{tok:">>",type:2},{tok:"x",type:3}]]).filter(t=>0!==t[0].type||0!==t[2].type),e=new Map;return t.forEach(t=>{e.set(t.map(t=>t.tok).join(""),{left:t[0].type,line:t[1].type,right:t[2].type})}),e})()},$t=["none","box","cross","fade","bar"],te=new Map;te.set("text",{mode:"text",types:{left:{max:Number.POSITIVE_INFINITY,min:0,skip:["of"],type:"note left"},right:{max:Number.POSITIVE_INFINITY,min:0,skip:["of"],type:"note right"}}}),te.set("note",{mode:"note",types:{between:{max:Number.POSITIVE_INFINITY,min:2,skip:[],type:"note between"},left:{max:Number.POSITIVE_INFINITY,min:0,skip:["of"],type:"note left"},over:{max:Number.POSITIVE_INFINITY,min:0,skip:[],type:"note over"},right:{max:Number.POSITIVE_INFINITY,min:0,skip:["of"],type:"note right"}}}),te.set("state",{mode:"state",types:{over:{max:1,min:1,skip:[],type:"note over"}}});const ee=new Map;ee.set("line",{defaultHeight:6}),ee.set("space",{defaultHeight:6}),ee.set("delay",{defaultHeight:30}),ee.set("tear",{defaultHeight:6});const ne=new Map;ne.set("define",{type:"agent define"}),ne.set("begin",{mode:"box",type:"agent begin"}),ne.set("end",{mode:"cross",type:"agent end"});const re=[{begin:["title"],fn:(t,e)=>(e.title=O(t,1),!0)},{begin:["theme"],fn:(t,e)=>(e.theme=O(t,1),!0)},{begin:["terminators"],fn:(t,e)=>{const n=z(t[1]);if(!n)throw L("Unspecified termination",t[0]);if(-1===$t.indexOf(n))throw L('Unknown termination "'+n+'"',t[1]);return e.terminators=n,!0}},{begin:["headers"],fn:(t,e)=>{const n=z(t[1]);if(!n)throw L("Unspecified header",t[0]);if(-1===$t.indexOf(n))throw L('Unknown header "'+n+'"',t[1]);return e.headers=n,!0}},{begin:["divider"],fn:t=>{const e=B(t,[":"],{orEnd:!0}),n=B(t,["with","height"],{limit:e,orEnd:!0}),r=O(t,1,n)||"line";if(!ee.has(r))throw L("Unknown divider type",t[1]);const s=function(t,e=0,n=null,r=Number.NAN){const s=O(t,e,n);return Number(s||r)}(t,n+2,e,ee.get(r).defaultHeight);if(Number.isNaN(s)||s<0)throw L("Invalid divider height",t[n+2]);return{height:s,label:O(t,e+1),mode:r,type:"divider"}}},{begin:["autolabel"],fn:t=>{let e=null;return e="off"===z(t[1])?"<label>":O(t,1),{pattern:function(t){const e=[];let n=null,r=0;for(Qt.lastIndex=0;n=Qt.exec(t);)n[1]&&e.push(n[1]),n[2]&&e.push(C(n[2])),r=Qt.lastIndex;const s=t.substr(r);return s&&e.push(s),e}(e),type:"label pattern"}}},{begin:["end"],fn:t=>1!==t.length?null:{type:"block end"}},{begin:[],fn:t=>{const e=Kt.get(z(t[0]));if(!e)return null;let n=1;return t.length>n&&(n=V(t,n,e.skip,"Invalid block command")),n=V(t,n,[":"]),{blockType:e.blockType,label:O(t,n),tag:e.tag,type:e.type}}},{begin:["begin","reference"],fn:t=>{let e=[];const n=B(t,[":"]);if("over"===z(t[2])&&n>3)e=H(t,3,n);else if(2!==n)throw L('Expected ":" or "over"',t[2]);const r=T(t,n+1,t.length,{aliases:!0});if(!r.alias)throw L("Reference must have an alias",t[n]);return{agents:e,alias:r.alias,blockType:"ref",label:r.name,tag:"ref",type:"group begin"}}},{begin:[],fn:t=>{const e=ne.get(z(t[0]));return!e||t.length<=1?null:Object.assign({agents:H(t,1,t.length,{aliases:!0})},e)}},{begin:["simultaneously"],fn:t=>{if(":"!==z(s(t)))return null;let e="";if(t.length>2){if("with"!==z(t[1]))return null;e=O(t,2,t.length-1)}return{target:e,type:"async"}}},{begin:[],fn:t=>{const e=te.get(z(t[0])),n=B(t,[":"]);if(!e||-1===n)return null;const r=e.types[z(t[1])];if(!r)return null;let s=2;const i=H(t,s=V(t,s,r.skip),n);if(i.length<r.min)throw L("Too few agents for "+e.mode,t[0]);if(i.length>r.max)throw L("Too many agents for "+e.mode,t[0]);return{agents:i,label:O(t,n+1),mode:e.mode,type:r.type}}},{begin:[],fn:t=>{const e=B(t,[":"],{orEnd:!0}),n=function(t,e,{start:n=0,limit:r=null}={}){const s=N(t,r);for(let r=n;r<s;++r){const n=e.get(z(t[r]));if(n)return{pos:r,value:n}}return null}(t,_t.types,{limit:e-1,start:0});if(!n)return null;const r=n.pos,s={flagTypes:_t.agentFlags};if("..."===z(t[0]))return{agent:T(t,r+1,e,s),label:O(t,e+1),options:n.value,tag:O(t,1,r),type:"connect-delay-end"};if("..."===z(t[r+1])){if(e!==t.length)throw L("Cannot label beginning of delayed connection",t[e]);return{agent:T(t,0,r,s),options:n.value,tag:O(t,r+2,e),type:"connect-delay-begin"}}return{agents:[T(t,0,r,s),T(t,r+1,e,s)],label:O(t,e+1),options:n.value,type:"connect"}}},{begin:[],fn:t=>t.length<2||":"!==z(s(t))?null:{name:O(t,0,t.length-1),type:"mark"}},{begin:[],fn:t=>{const e=B(t,["is"]);if(e<1)return null;let n=e+1;if(["a","an"].includes(z(t[n]))&&++n,n===t.length)throw L("Empty agent options",{b:s(t).e});const r=T(t,0,e),i=[];for(let e=n;e<t.length;++e)i.push(t[e].v);return{agent:r,options:i,type:"agent options"}}}],se=new class{tokenise(t){const e=[],n=new Xt(t);for(;!n.isOver();){const t=n.advance();t&&e.push(t)}if(n.block)throw new Error("Unterminated literal (began at "+function(t){return"line "+(t.ln+1)+", character "+t.ch}(n.token.b)+")");return e}getCodeMirrorMode(t){return new Ut(Wt,t)}splitLines(t){const e=[];let n=[];return t.forEach(t=>{t.q||"\n"!==t.v?n.push(t):n.length>0&&(e.push(n),n=[])}),n.length>0&&e.push(n),e}};class ie{getCodeMirrorMode(){return se.getCodeMirrorMode(Array.from(_t.types.keys()))}parseLines(t,e){const n={meta:{code:e,headers:"box",terminators:"none",textFormatter:D,theme:"",title:""},stages:[]};return t.forEach(t=>P(t,n)),n}parse(t){const e=se.tokenise(t),n=se.splitLines(e);return this.parseLines(n,t)}}class ae{makeState(){}resetState(t){this.makeState(t)}prepareMeasurements(){}separationPre(){}separation(){}renderPre(){}render(){}renderHidden(){}shouldHide(){}}const oe=new Map,le={class:"outline",fill:"transparent"};const he={bar:new class{prepareMeasurements({formattedLabel:t},e){const n=e.theme.agentCap.box;e.textSizer.expectMeasure(n.labelAttrs,t)}separation({formattedLabel:t},e){const n=e.theme.agentCap.box,r=e.textSizer.measure(n.labelAttrs,t).width+n.padding.left+n.padding.right;return{left:r/2,radius:r/2,right:r/2}}topShift(t,e){return e.theme.agentCap.bar.height/2}render(t,{x:e,formattedLabel:n,options:r},s){const i=s.theme.agentCap.box,a=s.theme.agentCap.bar,o=s.textSizer.measure(i.labelAttrs,n).width+i.padding.left+i.padding.right,{height:l}=a;return s.makeRegion().add(a.render({height:l,options:r,width:o,x:e-o/2,y:t}),s.svg.box(le,{height:l,width:o,x:e-o/2,y:t})),{height:l,lineBottom:l,lineTop:0}}},box:new class{getConfig(t,e){let n=null;return t.includes("database")&&(n=e.theme.agentCap.database),n||e.theme.agentCap.box}prepareMeasurements({formattedLabel:t,options:e},n){const r=this.getConfig(e,n);n.textSizer.expectMeasure(r.labelAttrs,t)}separation({formattedLabel:t,options:e},n){const r=this.getConfig(e,n),s=n.textSizer.measure(r.labelAttrs,t).width+r.padding.left+r.padding.right;return{left:s/2,radius:s/2,right:s/2}}topShift({formattedLabel:t,options:e},n){const r=this.getConfig(e,n),s=n.textSizer.measureHeight(r.labelAttrs,t)+r.padding.top+r.padding.bottom;return Math.max(0,s-r.arrowBottom)}render(t,{x:e,formattedLabel:n,options:r},s){const i=this.getConfig(r,s),a=s.svg.boxedText(i,n,{x:e,y:t});return s.makeRegion().add(a,s.svg.box(le,{height:a.height,width:a.width,x:e-a.width/2,y:t})),{height:a.height,lineBottom:a.height,lineTop:0}}},cross:new class{prepareMeasurements(){}separation(t,e){const n=e.theme.agentCap.cross;return{left:n.size/2,radius:0,right:n.size/2}}topShift(t,e){return e.theme.agentCap.cross.size/2}render(t,{x:e,options:n},r){const s=r.theme.agentCap.cross,i=s.size/2;return r.makeRegion().add(s.render({options:n,radius:i,x:e,y:t+i}),r.svg.box(le,{height:2*i,width:2*i,x:e-i,y:t})),{height:2*i,lineBottom:i,lineTop:i}}},fade:new class{prepareMeasurements(){}separation({currentRad:t}){return{left:t,radius:t,right:t}}topShift(t,e,n){const r=e.theme.agentCap.fade;return n?r.height:0}render(t,{x:e},n,r){const s=n.theme.agentCap.fade,i=s.height/(s.height+s.extend),a=n.addDef(r?"FadeIn":"FadeOut",()=>n.svg.linearGradient({x1:"0%",x2:"0%",y1:r?"100%":"0%",y2:r?"0%":"100%"},[{offset:"0%","stop-color":"#FFFFFF"},{offset:(100*i).toFixed(3)+"%","stop-color":"#000000"}]));return n.lineMaskLayer.add(n.svg.box({fill:"url(#"+a+")"},{height:s.height+s.extend,width:s.width,x:e-s.width/2,y:t-(r?s.extend:0)})),n.makeRegion().add(n.svg.box(le,{height:s.height,width:s.width,x:e-s.width/2,y:t})),{height:s.height,lineBottom:0,lineTop:s.height}}},none:new class{prepareMeasurements(){}separation({currentRad:t}){return{left:t,radius:t,right:t}}topShift(t,e){return e.theme.agentCap.none.height}render(t,{x:e},n){const r=n.theme.agentCap.none;return n.makeRegion().add(n.svg.box(le,{height:r.height,width:10,x:e-5,y:t})),{height:r.height,lineBottom:0,lineTop:r.height}}}};class de extends ae{constructor(t){super(),this.begin=t}prepareMeasurements({mode:t,agentIDs:e},n){e.forEach(e=>{const r=n.agentInfos.get(e);he[t].prepareMeasurements(r,n,this.begin)})}separationPre({mode:t,agentIDs:e},n){e.forEach(e=>{const r=n.agentInfos.get(e),s=he[t].separation(r,n,this.begin);n.addSpacing(e,s),r.currentMaxRad=Math.max(r.currentMaxRad,s.radius)})}separation({agentIDs:t},r){this.begin?e(r.visibleAgentIDs,t):n(r.visibleAgentIDs,t)}renderPre({mode:t,agentIDs:e},n){let r=0;return e.forEach(e=>{const s=n.agentInfos.get(e),i=he[t],a=i.topShift(s,n,this.begin);r=Math.max(r,a);const o=i.separation(s,n,this.begin).radius;s.currentMaxRad=Math.max(s.currentMaxRad,o)}),{agentIDs:e,topShift:r}}render({mode:t,agentIDs:e},n){let r=0;return e.forEach(e=>{const s=n.agentInfos.get(e),i=he[t],a=i.topShift(s,n,this.begin),o=n.primaryY-a,l=i.render(o,s,n,this.begin);r=Math.max(r,o+l.height),this.begin?n.drawAgentLine(e,o+l.lineBottom):n.drawAgentLine(e,o+l.lineTop,!0)}),r+n.theme.actionMargin}renderHidden({agentIDs:t},e){t.forEach(t=>{e.drawAgentLine(t,e.topY,!this.begin)})}}q("agent begin",new de(!0)),q("agent end",new de(!1));q("agent highlight",new class extends ae{radius(t,e){return t?e.theme.agentLineHighlightRadius:0}separationPre({agentIDs:t,highlighted:e},n){const r=this.radius(e,n);t.forEach(t=>{const e=n.agentInfos.get(t);e.currentRad=r,e.currentMaxRad=Math.max(e.currentMaxRad,r)})}renderPre({agentIDs:t,highlighted:e},n){const r=this.radius(e,n);t.forEach(t=>{const e=n.agentInfos.get(t);e.currentMaxRad=Math.max(e.currentMaxRad,r)})}render({agentIDs:t,highlighted:e},n){const r=this.radius(e,n);return t.forEach(t=>{n.drawAgentLine(t,n.primaryY),n.agentInfos.get(t).currentRad=r}),n.primaryY+n.theme.actionMargin}renderHidden(t,e){this.render(t,e)}});const ge={class:"outline",fill:"transparent"};class ce extends ae{prepareMeasurements({left:t,tag:e,label:n},r){const s=r.state.blocks.get(t),i=r.theme.getBlock(s.type).section;r.textSizer.expectMeasure(i.tag.labelAttrs,e),r.textSizer.expectMeasure(i.label.labelAttrs,n)}separation({left:t,right:e,tag:n,label:r},s){const i=s.state.blocks.get(t),a=s.theme.getBlock(i.type).section,o=s.textSizer.measure(a.tag.labelAttrs,n).width+a.tag.padding.left+a.tag.padding.right+s.textSizer.measure(a.label.labelAttrs,r).width+a.label.padding.left+a.label.padding.right;s.addSeparation(t,e,o)}renderPre({left:t,right:e}){return{agentIDs:[t,e]}}render({left:t,right:e,tag:n,label:r},s,i=!1){const a=s.state.blocks.get(t),o=s.theme.getBlock(a.type),l=s.agentInfos.get(t),h=s.agentInfos.get(e);let d=s.primaryY;i||(d+=o.section.padding.bottom);const g=s.makeRegion(),c=s.svg.boxedText({boxAttrs:o.section.tag.boxAttrs,boxRenderer:o.section.tag.boxRenderer,labelAttrs:o.section.tag.labelAttrs,padding:o.section.tag.padding},n,{x:l.x,y:d}),u=s.svg.boxedText({boxAttrs:{fill:"#000000"},labelAttrs:o.section.label.labelAttrs,padding:o.section.label.padding},r,{x:l.x+c.width,y:d}),p=Math.max(Math.max(c.height,u.height),o.section.label.minHeight);return a.hold.add(c.box),s.lineMaskLayer.add(u.box),g.add(s.svg.box(ge,{height:p,width:h.x-l.x,x:l.x,y:d}),c.label,u.label),i?a.canHide&&g.addClass(a.hide?"collapsed":"expanded"):a.hold.add(o.sepRenderer({x1:l.x,x2:h.x,y1:d,y2:d})),d+p+o.section.padding.top}}q("block begin",new class extends ce{makeState(t){t.blocks=new Map}resetState(t){t.blocks.clear()}storeBlockInfo(t,e){const{canHide:n}=t,r={canHide:n,hide:n&&e.renderer.isCollapsed(t.ln),hold:null,startY:null,type:t.blockType};return e.state.blocks.set(t.left,r),r}prepareMeasurements(t,e){this.storeBlockInfo(t,e),super.prepareMeasurements(t,e)}separationPre(t,e){this.storeBlockInfo(t,e),super.separationPre(t,e)}separation(t,n){e(n.visibleAgentIDs,[t.left,t.right]),super.separation(t,n)}renderPre(t,e){const n=this.storeBlockInfo(t,e),r=e.theme.getBlock(n.type);return{agentIDs:[t.left,t.right],topShift:r.margin.top}}render(t,e){const n=e.svg.el("g");e.blockLayer.add(n);const r=e.state.blocks.get(t.left);return r.hold=n,r.startY=e.primaryY,super.render(t,e,!0)}shouldHide({left:t},e){return{nest:e.state.blocks.get(t).hide?1:0,self:!1}}}),q("block split",new ce),q("block end",new class extends ae{separation({left:t,right:e},r){n(r.visibleAgentIDs,[t,e])}renderPre({left:t,right:e},n){const r=n.state.blocks.get(t);return{agentIDs:[t,e],topShift:n.theme.getBlock(r.type).section.padding.bottom}}render({left:t,right:e},n){const r=n.state.blocks.get(t),s=n.theme.getBlock(r.type),i=n.agentInfos.get(t),a=n.agentInfos.get(e);let o=s.boxRenderer;r.hide&&(o=s.collapsedBoxRenderer||o);let l=o({height:n.primaryY-r.startY,width:a.x-i.x,x:i.x,y:r.startY});return l.shape||(l={shape:l}),r.hold.add(l.shape),n.fillLayer.add(l.fill),n.lineMaskLayer.add(l.mask),n.primaryY+s.margin.bottom+n.theme.actionMargin}shouldHide({left:t},e){return{nest:e.state.blocks.get(t).hide?-1:0,self:!1}}});const ue={class:"outline",fill:"transparent"};class pe{constructor(t){this.propName=t}getConfig(t){return t.connect.arrow[this.propName]}short(t){const e=this.getConfig(t),n=e.attrs["stroke-linejoin"]||"miter",r=.5*e.attrs["stroke-width"],s=.5*t.agentLineAttrs[""]["stroke-width"];if("round"===n)return s+r;{const t=e.height/2,n=e.width;return s+r*Math.sqrt(n*n/(t*t)+1)}}render(t,e,n,r){const s=this.getConfig(e),i=this.short(e);t.add(s.render(s.attrs,{dir:r,height:s.height,width:s.width,x:n.x+i*r.dx,y:n.y+i*r.dy}))}width(t){return this.short(t)+this.getConfig(t).width}height(t){return this.getConfig(t).height}lineGap(t,e){const n=this.getConfig(t),r=this.short(t);if("none"===n.attrs.fill){const t=n.height/2,s=n.width;return(r+(r+e["stroke-width"]/2*(s/t)))/2}return r+n.width/2}}const fe=[{height:()=>0,lineGap:()=>0,render:()=>null,width:()=>0},new pe("single"),new pe("double"),new class{getConfig(t){return t.connect.arrow.cross}render(t,e,n,r){const s=this.getConfig(e);t.add(s.render({radius:s.radius,x:n.x+s.short*r.dx,y:n.y+s.short*r.dy}))}width(t){const e=this.getConfig(t);return e.short+e.radius}height(t){return 2*this.getConfig(t).radius}lineGap(t){return this.getConfig(t).short}}];class me extends ae{prepareMeasurements({agentIDs:t,label:e},n){const r=n.theme.connect,s=t[0]===t[1]?r.label.loopbackAttrs:r.label.attrs;n.textSizer.expectMeasure(s,e)}separationPre({agentIDs:t},e){const n=e.theme.connect.source.radius;t.forEach(t=>{const r=e.agentInfos.get(t);r.isVirtualSource&&(r.currentRad=n,r.currentMaxRad=Math.max(r.currentMaxRad,n))})}separation({label:t,agentIDs:n,options:r},s){const i=s.theme.connect,a=fe[r.left],o=fe[r.right],l=n[0]===n[1],h=l?i.label.loopbackAttrs:i.label.attrs;let d=s.textSizer.measure(h,t).width;d>0&&(d+=2*i.label.padding);const g=s.agentInfos.get(n[0]);if(l)s.addSpacing(n[0],{left:0,right:g.currentMaxRad+Math.max(d+a.width(s.theme),o.width(s.theme))+i.loopbackRadius});else{const t=s.agentInfos.get(n[1]);s.addSeparation(n[0],n[1],g.currentMaxRad+t.currentMaxRad+d+2*Math.max(a.width(s.theme),o.width(s.theme)))}e(s.momentaryAgentIDs,n)}renderRevArrowLine({x1:t,y1:e,x2:n,y2:r,xR:s},i,a,o){const l=a.theme.connect,h=l.line[i.line],d=fe[i.left],g=fe[i.right],c=d.lineGap(a.theme,h.attrs),u=g.lineGap(a.theme,h.attrs),p=h.renderRev(h.attrs,{rad:l.loopbackRadius,x1:t+c,x2:n+u,xR:s,y1:e,y2:r});o.add(p.shape),d.render(o,a.theme,{x:p.p1.x-c,y:p.p1.y},{dx:1,dy:0}),g.render(o,a.theme,{x:p.p2.x-u,y:p.p2.y},{dx:1,dy:0})}renderSelfConnect({label:t,agentIDs:e,options:n},r,s,i){const a=r.theme.connect,o=fe[n.left],l=fe[n.right],h=r.agentInfos.get(e[1]),d=t?r.textSizer.measureHeight(a.label.attrs,t)+a.label.margin.top+a.label.margin.bottom:0,g=s.x+s.currentMaxRad+o.width(r.theme)+(t?a.label.padding:0),c=r.svg.boxedText({boxAttrs:{fill:"#000000"},labelAttrs:a.label.loopbackAttrs,padding:a.mask.padding},t,{x:g-a.mask.padding.left,y:i-d+a.label.margin.top}),u=t?c.width+a.label.padding-a.mask.padding.left-a.mask.padding.right:0,p=Math.max(h.x+h.currentMaxRad+l.width(r.theme),g+u),f=Math.max(d,o.height(r.theme)/2),m=l.height(r.theme)/2;r.lineMaskLayer.add(c.box);const b=r.makeRegion().add(r.svg.box(ue,{height:f+r.primaryY-i+m,width:p+a.loopbackRadius-s.x,x:s.x,y:i-f}),c.label);return this.renderRevArrowLine({x1:s.x+s.currentMaxRad,x2:h.x+h.currentMaxRad,xR:p,y1:i,y2:r.primaryY},n,r,b),r.primaryY+Math.max(m,0)+r.theme.actionMargin}renderArrowLine({x1:t,y1:e,x2:n,y2:r},s,i,a){const o=i.theme.connect.line[s.line],l=fe[s.left],h=fe[s.right],d=Math.sqrt((n-t)*(n-t)+(r-e)*(r-e)),g=l.lineGap(i.theme,o.attrs),c=h.lineGap(i.theme,o.attrs),u=(n-t)/d,p=(r-e)/d,f=o.renderFlat(o.attrs,{x1:t+g*u,x2:n-c*u,y1:e+g*p,y2:r-c*p});a.add(f.shape);const m={x:f.p1.x-g*u,y:f.p1.y-g*p},b={x:f.p2.x+c*u,y:f.p2.y+c*p};return l.render(a,i.theme,m,{dx:u,dy:p}),h.render(a,i.theme,b,{dx:-u,dy:-p}),{lArrow:l,p1:m,p2:b,rArrow:h}}renderVirtualSources({from:t,to:e,rendered:n},r,s){const i=r.theme.connect.source;t.isVirtualSource&&s.add(i.render({radius:i.radius,x:n.p1.x-i.radius,y:n.p1.y})),e.isVirtualSource&&s.add(i.render({radius:i.radius,x:n.p2.x+i.radius,y:n.p2.y}))}renderSimpleLabel(t,{layer:e,x1:n,x2:r,y1:s,y2:i,height:a},o){const l=o.theme.connect,h=(n+r)/2,d=(s+i)/2;let g=e;const c={fill:"#000000"};if(s!==i){const t="rotate("+180*Math.atan((i-s)/(r-n))/Math.PI+" "+h+","+d+")";c.transform=t,g=o.svg.el("g").attr("transform",t),e.add(g)}const u=o.svg.boxedText({boxAttrs:c,labelAttrs:l.label.attrs,padding:l.mask.padding},t,{x:h,y:d+l.label.margin.top-a});o.lineMaskLayer.add(u.box),g.add(u.label)}renderSimpleConnect({label:t,agentIDs:e,options:n},r,s,i){const a=r.theme.connect,o=r.agentInfos.get(e[1]),l=s.x<o.x?1:-1,h=r.textSizer.measureHeight(a.label.attrs,t)+a.label.margin.top+a.label.margin.bottom,d=s.x+s.currentMaxRad*l,g=o.x-o.currentMaxRad*l,c=r.makeRegion(),u=this.renderArrowLine({x1:d,x2:g,y1:i,y2:r.primaryY},n,r,c),p=Math.max(u.lArrow.height(r.theme),u.rArrow.height(r.theme))/2,f=Math.max(h,p);return this.renderVirtualSources({from:s,rendered:u,to:o},r,c),c.add(r.svg.el("path").attrs(ue).attr("d","M"+d+","+(i-f)+"L"+g+","+(r.primaryY-f)+"L"+g+","+(r.primaryY+p)+"L"+d+","+(i+p)+"Z")),this.renderSimpleLabel(t,{height:h,layer:c,x1:d,x2:g,y1:i,y2:r.primaryY},r),r.primaryY+Math.max(p+r.theme.minActionMargin,r.theme.actionMargin)}renderPre({label:t,agentIDs:e,options:n},r){const s=r.theme.connect,i=fe[n.left],a=fe[n.right],o=r.textSizer.measureHeight(s.label.attrs,t)+s.label.margin.top+s.label.margin.bottom;let l=i.height(r.theme);return e[0]!==e[1]&&(l=Math.max(l,a.height(r.theme))),{agentIDs:e,topShift:Math.max(l/2,o)}}render(t,e,n=null,r=null){let s=r,i=n;return null===n&&(i=e.agentInfos.get(t.agentIDs[0]),s=e.primaryY),t.agentIDs[0]===t.agentIDs[1]?this.renderSelfConnect(t,e,i,s):this.renderSimpleConnect(t,e,i,s)}}q("connect",new me),q("connect-delay-begin",new class extends me{makeState(t){t.delayedConnections=new Map}resetState(t){t.delayedConnections.clear()}separation(t,n){super.separation(t,n),e(n.momentaryAgentIDs,[t.agentIDs[0]])}renderPre(t,e){return Object.assign(super.renderPre(t,e),{agentIDs:[t.agentIDs[0]]})}render(t,e){return e.state.delayedConnections.set(t.tag,{from:Object.assign({},e.agentInfos.get(t.agentIDs[0])),stage:t,y:e.primaryY}),e.primaryY+e.theme.actionMargin}renderHidden(t,e){this.render(t,e)}}),q("connect-delay-end",new class extends me{prepareMeasurements(){}separationPre(){}separation(){}renderPre({tag:t},e){const n=e.theme.connect,r=e.state.delayedConnections.get(t),s=r.stage,i=[s.agentIDs[1]];return s.agentIDs[0]===s.agentIDs[1]?{agentIDs:i,y:r.y+2*n.loopbackRadius}:Object.assign(super.renderPre(s,e),{agentIDs:i})}render({tag:t},e){const n=e.state.delayedConnections.get(t);return super.render(n.stage,e,n.from,n.y)}});const be={class:"outline",fill:"transparent"};q("divider",new class extends ae{prepareMeasurements({mode:t,formattedLabel:e},n){const r=n.theme.getDivider(t);n.textSizer.expectMeasure(r.labelAttrs,e)}separation({mode:t,formattedLabel:e},n){const r=n.theme.getDivider(t),s=n.textSizer.measure(r.labelAttrs,e).width+r.padding.left+r.padding.right;n.addSeparation("[","]",s),n.addSpacing("[",{left:r.extend,right:0}),n.addSpacing("]",{left:0,right:r.extend})}renderPre(){return{agentIDs:["[","]"]}}render({mode:t,height:e,formattedLabel:n},r){const s=r.theme.getDivider(t),i=r.agentInfos.get("["),a=r.agentInfos.get("]");let o=0,l=0;n&&(l=r.textSizer.measureHeight(s.labelAttrs,n));const h=Math.max(e,l)+s.margin;let d=null;if(n){const t=r.svg.boxedText({boxAttrs:{fill:"#000000"},labelAttrs:s.labelAttrs,padding:s.padding},n,{x:(i.x+a.x)/2,y:r.primaryY+(h-l)/2-s.padding.top});r.fullMaskLayer.add(t.box),d=t.label,o=t.width}const{shape:g,mask:c}=s.render({env:r,height:e,labelHeight:l,labelWidth:o,width:a.x-i.x+2*s.extend,x:i.x-s.extend,y:r.primaryY+(h-e)/2});return r.fullMaskLayer.add(c),r.makeRegion({unmasked:!0}).add(r.svg.box(be,{height:h,width:a.x-i.x+2*s.extend,x:i.x-s.extend,y:r.primaryY}),g,d),r.primaryY+h+r.theme.actionMargin}});q("mark",new class extends ae{makeState(t){t.marks=new Map}resetState(t){t.marks.clear()}render({name:t},{topY:e,state:n}){n.marks.set(t,e)}renderHidden(t,e){this.render(t,e)}}),q("async",new class extends ae{renderPre({target:t},{state:e}){let n=0;return t&&e.marks&&(n=e.marks.get(t)||0),{asynchronousY:n}}});const ye={class:"outline",fill:"transparent"};class xe extends ae{prepareMeasurements({mode:t,label:e},n){const r=n.theme.getNote(t);n.textSizer.expectMeasure(r.labelAttrs,e)}renderPre({agentIDs:t}){return{agentIDs:t}}renderNote({label:t,mode:e,position:n},r){const s=r.theme.getNote(e),{padding:i}=s,a=r.topY+s.margin.top+i.top,o=r.svg.formattedText(s.labelAttrs,t),l=r.textSizer.measure(o),h=l.width+i.left+i.right,d=l.height+i.top+i.bottom,g=function(t,{x0:e=null,x1:n=null,xMid:r=null}){let s=e,i=n;return null===s&&null!==r&&(s=r-t/2),null===i&&null!==s?i=s+t:null===s&&(s=i-t),{xL:s,xR:i}}(h,n);o.set({x:function(t,{xL:e,xR:n},r){switch(t){case"middle":return(e+r.left+n-r.right)/2;case"end":return n-r.right;default:return e+r.left}}(s.labelAttrs["text-anchor"],g,i),y:a});const c={height:d,width:g.xR-g.xL,x:g.xL,y:r.topY+s.margin.top};return r.makeRegion().add(s.boxRenderer(c),r.svg.box(ye,c),o),r.topY+s.margin.top+d+s.margin.bottom+r.theme.actionMargin}}class we extends xe{constructor(t){super(),this.isRight=t}separation({agentIDs:t,mode:e,label:n},r){const s=r.theme.getNote(e),{left:i,right:a}=Y(r.agentInfos,t),o=r.textSizer.measure(s.labelAttrs,n).width+s.padding.left+s.padding.right+s.margin.left+s.margin.right;if(this.isRight){const t=r.agentInfos.get(a);r.addSpacing(a,{left:0,right:o+t.currentMaxRad})}else{const t=r.agentInfos.get(i);r.addSpacing(i,{left:o+t.currentMaxRad,right:0})}}render({agentIDs:t,mode:e,label:n},r){const s=r.theme.getNote(e),{left:i,right:a}=Y(r.agentInfos,t);if(this.isRight){const t=r.agentInfos.get(a),i=t.x+t.currentMaxRad+s.margin.left;return this.renderNote({label:n,mode:e,position:{x0:i}},r)}{const t=r.agentInfos.get(i),a=t.x-t.currentMaxRad-s.margin.right;return this.renderNote({label:n,mode:e,position:{x1:a}},r)}}}q("note over",new class extends xe{separation({agentIDs:t,mode:e,label:n},r){const s=r.theme.getNote(e),i=r.textSizer.measure(s.labelAttrs,n).width+s.padding.left+s.padding.right,{left:a,right:o}=Y(r.agentInfos,t),l=r.agentInfos.get(a),h=r.agentInfos.get(o);if(l===h)r.addSpacing(a,{left:i/2,right:i/2});else{const t=l.currentMaxRad+s.overlap.left,e=h.currentMaxRad+s.overlap.right;r.addSeparation(a,o,i-t-e),r.addSpacing(a,{left:t,right:0}),r.addSpacing(o,{left:0,right:e})}}render({agentIDs:t,mode:e,label:n},r){const s=r.theme.getNote(e),{left:i,right:a}=Y(r.agentInfos,t),o=r.agentInfos.get(i),l=r.agentInfos.get(a);if(o===l){const t=o.x;return this.renderNote({label:n,mode:e,position:{xMid:t}},r)}return this.renderNote({label:n,mode:e,position:{x0:o.x-o.currentMaxRad-s.overlap.left,x1:l.x+l.currentMaxRad+s.overlap.right}},r)}}),q("note left",new we(!1)),q("note right",new we(!0)),q("note between",new class extends xe{separation({agentIDs:t,mode:e,label:n},r){const s=r.theme.getNote(e),{left:i,right:a}=Y(r.agentInfos,t),o=r.agentInfos.get(i),l=r.agentInfos.get(a);r.addSeparation(i,a,r.textSizer.measure(s.labelAttrs,n).width+s.padding.left+s.padding.right+s.margin.left+s.margin.right+o.currentMaxRad+l.currentMaxRad)}render({agentIDs:t,mode:e,label:n},r){const{left:s,right:i}=Y(r.agentInfos,t),a=r.agentInfos.get(s),o=r.agentInfos.get(i),l=(a.x+a.currentMaxRad+o.x-o.currentMaxRad)/2;return this.renderNote({label:n,mode:e,position:{xMid:l}},r)}});q("parallel",new class extends ae{invokeChildren(t,e,n){return t.stages.map(t=>e.components.get(t.type)[n](t,e))}prepareMeasurements(t,e){this.invokeChildren(t,e,"prepareMeasurements")}separationPre(t,e){this.invokeChildren(t,e,"separationPre")}separation(t,e){this.invokeChildren(t,e,"separation")}renderPre(t,e){return this.invokeChildren(t,e,"renderPre").map(t=>j(t)).reduce(W,{agentIDs:[],asynchronousY:null,topShift:0})}render(t,e){const n=e.makeRegion;let r=0;return t.stages.forEach(t=>{e.makeRegion=((e={})=>n(Object.assign({stageOverride:t},e)));const s=e.components.get(t.type).render(t,e)||0;r=Math.max(r,s)}),e.makeRegion=n,r}renderHidden(t,e){this.invokeChildren(t,e,"renderHidden")}shouldHide(t,e){return this.invokeChildren(t,e,"shouldHide").reduce((t,{self:e=!1,nest:n=0}={})=>({nest:t.nest+n,self:t.self||Boolean(e)}),{nest:0,self:!1})}});class ke{constructor(t){this.element=t}addBefore(t=null,e=null){if(null===t)return this;if(Array.isArray(t))for(const n of t)this.addBefore(n,e);else{const n=function(t,e){return"string"==typeof t?e.createTextNode(t):"number"==typeof t?e.createTextNode(t.toString(10)):"object"==typeof t&&t.element?t.element:t}(t,this.element.ownerDocument);this.element.insertBefore(n,X(e))}return this}add(...t){return this.addBefore(t,null)}del(t=null){return null!==t&&this.element.removeChild(X(t)),this}attr(t,e){return this.element.setAttribute(t,e),this}attrs(t){for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&this.element.setAttribute(e,t[e]);return this}styles(t){for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(this.element.style[e]=t[e]);return this}setClass(t){return this.attr("class",t)}addClass(t){const e=this.element.getAttribute("class");if(!e)return this.setClass(t);const n=e.split(" ");return n.includes(t)?this:(n.push(t),this.attr("class",n.join(" ")))}delClass(t){const e=this.element.getAttribute("class");if(!e)return this;const n=e.split(" "),r=n.indexOf(t);return-1!==r&&(n.splice(r,1),this.attr("class",n.join(" "))),this}text(t){return this.element.textContent=t,this}on(t,e,n={}){if(Array.isArray(t))for(const r of t)this.on(r,e,n);else this.element.addEventListener(t,e,n);return this}off(t,e,n={}){if(Array.isArray(t))for(const r of t)this.off(r,e,n);else this.element.removeEventListener(t,e,n);return this}val(t){return this.element.value=t,this}select(t,e=null){return this.element.selectionStart=t,this.element.selectionEnd=null===e?t:e,this}focus(){return this.element.focus(),this}focussed(){return this.element===this.element.ownerDocument.activeElement}empty(){for(;this.element.childNodes.length>0;)this.element.removeChild(this.element.lastChild);return this}attach(t){return X(t).appendChild(this.element),this}detach(){return this.element.parentNode.removeChild(this.element),this}}class ve{constructor(t){if(!t)throw new Error("Missing document!");this.document=t,this.wrap=this.wrap.bind(this),this.el=this.el.bind(this),this.txt=this.txt.bind(this)}wrap(t){return t.element?t:new ke(t)}el(t,e=null){let n=null;return n=null===e?this.document.createElement(t):this.document.createElementNS(e,t),new ke(n)}txt(t=""){return this.document.createTextNode(t)}}const Ae=[];class Fe{constructor(t,e,n={}){this.container=t,this.svg=e,this.state={attrs:{},formatted:Ae,x:0,y:0},this.lines=[],this.set(n)}_rebuildLines(t){if(t>this.lines.length)for(;this.lines.length<t;)this.lines.push({latest:"",node:this.svg.el("text").attr("x",this.state.x).attrs(this.state.attrs).attach(this.container)});else for(;this.lines.length>t;)this.lines.pop().node.detach()}_reset(){this._rebuildLines(0)}_renderText(){const{formatted:t}=this.state;if(t&&t.length){if(!Array.isArray(t))throw new Error("Invalid formatted text: "+t);this._rebuildLines(t.length),this.lines.forEach((e,n)=>{const r=JSON.stringify(t[n]);r!==e.latest&&(e.node.empty(),Q(this.svg,e.node,t[n]),e.latest=r)})}else this._reset()}_updateX(){this.lines.forEach(({node:t})=>{t.attr("x",this.state.x)})}_updateY(){const t=this.svg.textSizer;let e=this.state.y;for(let n=0;n<this.lines.length;++n){const r=[this.state.formatted[n]],s=t.baseline(this.state.attrs,r);this.lines[n].node.attr("y",e+s),e+=t.measureHeight(this.state.attrs,r)}}set(t){const e=Object.assign({},this.state);!function(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&null!==e[n]&&void 0!==e[n]&&(t[n]=e[n])}(this.state,t),this.state.attrs!==e.attrs&&(this._reset(),e.formatted=Ae);const n=this.lines.length;this.state.formatted!==e.formatted&&this._renderText(),this.state.x!==e.x&&this._updateX(),this.state.y===e.y&&this.lines.length===n||this._updateY()}}class Se{constructor(t=null,e=0){this.pattern=t,this.dw=t&&t.partWidth,this.points=[],this.phase=e,this.x=null,this.y=null,this.disconnect=0}_nextDelta(){return this.pattern.getDelta(this.phase++)}_link(){2===this.disconnect&&(this.points.push(this.x+" "+this.y),this.disconnect=0)}cap(){return this.disconnect>0&&(this.points.push(this.x+" "+this.y),this.disconnect=0),this}move(t,e){return this.cap(),this.x=t,this.y=e,this.disconnect=2,this}line(t,e,{patterned:n=!0}={}){if(this.pattern&&n){const n=Math.sqrt((t-this.x)*(t-this.x)+(e-this.y)*(e-this.y)),r=(t-this.x)/n,s=(e-this.y)/n,i=-s,a=r;for(let t=0;t+this.dw<=n;t+=this.dw){const e=this._nextDelta();this.points.push(this.x+t*r+e*i+" "+(this.y+t*s+e*a))}this.disconnect=1}else this._link(),this.disconnect=2;return this.x=t,this.y=e,this}arc(t,e,n){const r=Math.sqrt((t-this.x)*(t-this.x)+(e-this.y)*(e-this.y)),s=Math.atan2(this.x-t,e-this.y),i=t+Math.sin(s+n)*r,a=e-Math.cos(s+n)*r;if(this.pattern){const i=n<0?1:-1,a=this.dw/r;for(let o=s;o+a<=s+n;o+=a){const n=this._nextDelta()*i;this.points.push(t+Math.sin(o)*(r+n)+" "+(e-Math.cos(o)*(r+n)))}this.disconnect=1}else this.points.push(this.x+" "+this.y+"A"+r+" "+r+" 0 "+(Math.abs(n)>=Math.PI?"1 ":"0 ")+(n<0?"0 ":"1 ")+i+" "+a),this.disconnect=0;return this.x=i,this.y=a,this}asPath(){return this._link(),"M"+this.points.join("L")}}const Me="http://www.w3.org/2000/svg",Re=t=>new class{constructor(t){this.svg=t,this.testers=this.svg.el("g").attrs({display:Ft?"block":"none",visibility:"hidden"}),this.container=t.body}baseline({attrs:t}){return Number(t["font-size"])}measureHeight({attrs:t,formatted:e}){const n=this.baseline({attrs:t,formatted:e})*(Number(t["line-height"])||1);return e.length*n}prepMeasurement(t,e){const n=this.svg.el("text").attrs(t).attach(this.testers);return Q(this.svg,n,e),n}prepComplete(){this.container.add(this.testers)}performMeasurement(t){return t.element.getComputedTextLength()}teardown(){this.container.del(this.testers.empty())}}(t);class Ce{constructor(t){this.sizer=t,this.cache=new Map,this.active=null}_expectMeasure({attrs:t,formatted:e}){if(!e.length)return null;const n=JSON.stringify(t);let r=this.cache.get(n);return r||(r={attrs:t,lines:new Map},this.cache.set(n,r)),e.forEach(t=>{if(!t.length)return;const e=JSON.stringify(t);r.lines.has(e)||r.lines.set(e,{formatted:t,width:null})}),r}_measureLine(t,e){if(!e.length)return 0;const n=JSON.stringify(e),r=t.lines.get(n);if(null===r.width)throw new Error("Unexpected measurement of "+e);return r.width}_measureWidth(t){if(!t.formatted.length)return 0;const e=this._expectMeasure(t);return t.formatted.map(t=>this._measureLine(e,t)).reduce((t,e)=>Math.max(t,e),0)}_getMeasurementOpts(t,e){const n={attrs:t,formatted:e};if(e||(t.textBlock?(n.attrs=t.textBlock.state.attrs,n.formatted=t.textBlock.state.formatted):t.state&&(n.attrs=t.state.attrs,n.formatted=t.state.formatted),n.formatted=n.formatted||[]),!Array.isArray(n.formatted))throw new Error("Invalid formatted text: "+n.formatted);return n}expectMeasure(t,e){const n=this._getMeasurementOpts(t,e);this._expectMeasure(n)}performMeasurementsPre(){this.active=[],this.cache.forEach(({attrs:t,lines:e})=>{e.forEach(e=>{null===e.width&&this.active.push({cacheLine:e,data:this.sizer.prepMeasurement(t,e.formatted)})})}),this.active.length&&this.sizer.prepComplete()}performMeasurementsAct(){this.active.forEach(({data:t,cacheLine:e})=>{e.width=this.sizer.performMeasurement(t)})}performMeasurementsPost(){this.active.length&&this.sizer.teardown(),this.active=null}performMeasurements(){try{this.performMeasurementsPre(),this.performMeasurementsAct()}finally{this.performMeasurementsPost()}}measure(t,e){const n=this._getMeasurementOpts(t,e);return{height:this.sizer.measureHeight(n),width:this._measureWidth(n)}}baseline(t,e){const n=this._getMeasurementOpts(t,e);return this.sizer.baseline(n)}measureHeight(t,e){const n=this._getMeasurementOpts(t,e);return this.sizer.measureHeight(n)}resetCache(){this.cache.clear()}}class Ie{constructor(t,e=null){this.dom=t,this.body=this.el("svg").attr("xmlns",Me).attr("version","1.1");const n=e||Re;this.textSizer=new Ce(n(this)),this.txt=this.txt.bind(this),this.el=this.el.bind(this)}linearGradient(t,e){return this.el("linearGradient").attrs(t).add(e.map(t=>this.el("stop").attrs(t)))}patternedLine(t=null,e=0){return new Se(t,e)}txt(t){return this.dom.txt(t)}el(t,e=Me){return this.dom.el(t,e)}box(t,{height:e,width:n,x:r,y:s}){return this.el("rect").attrs(t).attrs({height:e,width:n,x:r,y:s})}boxFactory(t){return this.box.bind(this,t)}line(t,{x1:e,x2:n,y1:r,y2:s}){return this.el("line").attrs(t).attrs({x1:e,x2:n,y1:r,y2:s})}lineFactory(t){return this.line.bind(this,t)}circle(t,{x:e,y:n,radius:r}){return this.el("circle").attrs({cx:e,cy:n,r:r}).attrs(t)}circleFactory(t){return this.circle.bind(this,t)}cross(t,{x:e,y:n,radius:r}){return this.el("path").attr("d","M"+(e-r)+" "+(n-r)+"l"+2*r+" "+2*r+"m0 "+2*-r+"l"+2*-r+" "+2*r).attrs(t)}crossFactory(t){return this.cross.bind(this,t)}note(t,e,{height:n,width:r,x:s,y:i}){const a=s,o=s+r,l=i,h=i+n;return this.el("g").add(this.el("polygon").attr("points",a+" "+l+" "+(o-7)+" "+l+" "+o+" "+(l+7)+" "+o+" "+h+" "+a+" "+h).attrs(t),this.el("polyline").attr("points",o-7+" "+l+" "+(o-7)+" "+(l+7)+" "+o+" "+(l+7)).attrs(e))}noteFactory(t,e){return this.note.bind(this,t,e)}formattedText(t={},e=[],{x:n,y:r}={}){const s=this.el("g"),i=new Fe(s,this,{attrs:t,formatted:e,x:n,y:r});return Object.assign(s,{set:t=>i.set(t),textBlock:i})}formattedTextFactory(t){return this.formattedText.bind(this,t)}boxedText({padding:t,labelAttrs:e,boxAttrs:n={},boxRenderer:r=null},s,{x:i,y:a}){if(!s||!s.length)return Object.assign(this.el("g"),{box:null,height:0,label:null,width:0});const{shift:o,anchorX:l}=function(t,e,n){let r=0,s=t;switch(e["text-anchor"]){case"middle":r=.5,s+=(n.left-n.right)/2;break;case"end":r=1,s-=n.right;break;default:r=0,s+=n.left}return{anchorX:s,shift:r}}(i,e,t),h=this.formattedText(e,s,{x:l,y:a+t.top}),d=this.textSizer.measure(h),g=d.width+t.left+t.right,c=d.height+t.top+t.bottom,u=(r||this.boxFactory(n))({height:c,width:g,x:l-d.width*o-t.left,y:a});return Object.assign(this.el("g").add(u,h),{box:u,height:c,label:h,width:g})}boxedTextFactory(t){return this.boxedText.bind(this,t)}}let Ee=0;class Ge extends kt{constructor({themes:t=[],namespace:e=null,components:n=null,document:r,textSizerFactory:s=null}={}){super(),this._bindMethods(),this.state={},this.width=0,this.height=0,this.themes=function(t){if(0===t.length)throw new Error("Cannot render without a theme");const e=new Map;return t.forEach(t=>{e.set(t.name,t)}),e.set("",t[0]),e}(t),this.themeBuilder=null,this.theme=null,this.namespace=function(t){return null===t?"R"+Ee++:t}(e),this.components=n||oe,this.svg=new Ie(new ve(r),s),this.knownThemeDefs=new Set,this.knownDefs=new Set,this.highlights=new Map,this.collapsed=new Set,this.currentHighlight=-1,this.buildStaticElements(),this.components.forEach(t=>{t.makeState(this.state)})}_bindMethods(){this.separationStage=this.separationStage.bind(this),this.prepareMeasurementsStage=this.prepareMeasurementsStage.bind(this),this.renderStage=this.renderStage.bind(this),this.addThemeDef=this.addThemeDef.bind(this),this.addDef=this.addDef.bind(this)}addTheme(t){this.themes.set(t.name,t)}buildStaticElements(){const{el:t}=this.svg;this.metaCode=this.svg.txt(),this.themeDefs=t("defs"),this.defs=t("defs"),this.fullMask=t("mask").attrs({id:this.namespace+"FullMask",maskUnits:"userSpaceOnUse"}),this.lineMask=t("mask").attrs({id:this.namespace+"LineMask",maskUnits:"userSpaceOnUse"}),this.fullMaskReveal=t("rect").attr("fill","#FFFFFF"),this.lineMaskReveal=t("rect").attr("fill","#FFFFFF"),this.backgroundFills=t("g"),this.agentLines=t("g").attr("mask","url(#"+this.namespace+"LineMask)"),this.blocks=t("g"),this.shapes=t("g"),this.unmaskedShapes=t("g"),this.title=this.svg.formattedText(),this.svg.body.add(this.svg.el("metadata").add(this.metaCode),this.themeDefs,this.defs,this.backgroundFills,this.title,this.unmaskedShapes,t("g").attr("mask","url(#"+this.namespace+"FullMask)").add(this.agentLines,this.blocks,this.shapes))}addThemeDef(t,e){const n=this.namespace+t;return this.knownThemeDefs.has(t)||(this.knownThemeDefs.add(t),this.themeDefs.add(e().attr("id",n))),n}addDef(t,e){let n=t,r=e;"function"!=typeof e&&(n="P"+this.knownDefs.size,r=(()=>t));const s=this.namespace+n;return this.knownDefs.has(n)||(this.knownDefs.add(n),this.defs.add(r().attr("id",s))),s}addSeparation(t,e,n){const r=this.agentInfos.get(t),s=this.agentInfos.get(e),i=r.separations.get(e)||0;r.separations.set(e,Math.max(i,n));const a=s.separations.get(t)||0;s.separations.set(t,Math.max(a,n))}checkHidden(t){const e=this.components.get(t.type),n={agentInfos:this.agentInfos,components:this.components,renderer:this,state:this.state,textSizer:this.svg.textSizer,theme:this.theme},r=e.shouldHide(t,n)||{},s=this.hideNest>0;this.hideNest+=r.nest||0;const i=this.hideNest>0;if(this.hideNest<0)throw new Error("Unexpected nesting in "+t.type);return s===i?i:Boolean(r.self)}separationStage(t){const n=new Map,r=this.visibleAgentIDs.slice(),s=[];this.agentInfos.forEach(t=>{const e=t.currentRad;t.currentMaxRad=e,n.set(t.id,{left:e,right:e})});const i={addSeparation:(t,e,n)=>{s.push({agentID1:t,agentID2:e,dist:n})},addSpacing:(t,{left:e,right:r})=>{const s=n.get(t);s.left=Math.max(s.left,e),s.right=Math.max(s.right,r)},agentInfos:this.agentInfos,components:this.components,momentaryAgentIDs:r,renderer:this,state:this.state,textSizer:this.svg.textSizer,theme:this.theme,visibleAgentIDs:this.visibleAgentIDs},a=this.components.get(t.type);if(!a)throw new Error("Unknown component: "+t.type);a.separationPre(t,i),a.separation(t,i),this.checkHidden(t)||(e(r,this.visibleAgentIDs),s.forEach(({agentID1:t,agentID2:e,dist:n})=>{this.addSeparation(t,e,n)}),r.forEach(t=>{const e=this.agentInfos.get(t),s=n.get(t);e.maxRPad=Math.max(e.maxRPad,s.right),e.maxLPad=Math.max(e.maxLPad,s.left),r.forEach(r=>{if(this.agentInfos.get(r).index>=e.index)return;const i=n.get(r);this.addSeparation(t,r,s.left+i.right+this.theme.agentMargin)})}))}prepareMeasurementsStage(t){const e={agentInfos:this.agentInfos,components:this.components,renderer:this,state:this.state,textSizer:this.svg.textSizer,theme:this.theme},n=this.components.get(t.type);if(!n)throw new Error("Unknown component: "+t.type);n.prepareMeasurements(t,e)}checkAgentRange(t,e=0){if(0===t.length)return e;const{left:n,right:r}=J(this.agentInfos,t),s=this.agentInfos.get(n).x,i=this.agentInfos.get(r).x;let a=e;return this.agentInfos.forEach(t=>{t.x>=s&&t.x<=i&&(a=Math.max(a,t.latestY))}),a}markAgentRange(t,e){if(0===t.length)return;const{left:n,right:r}=J(this.agentInfos,t),s=this.agentInfos.get(n).x,i=this.agentInfos.get(r).x;this.agentInfos.forEach(t=>{t.x>=s&&t.x<=i&&(t.latestY=e)})}drawAgentLine(t,e){null!==t.latestYStart&&e>t.latestYStart&&this.agentLines.add(this.theme.renderAgentLine({className:"agent-"+t.index+"-line",options:t.options,width:2*t.currentRad,x:t.x,y0:t.latestYStart,y1:e}))}addHighlightObject(t,e){let n=this.highlights.get(t);n||(n=[],this.highlights.set(t,n)),n.push(e)}forwardEvent(t,e,n,r){t.on(e,this.trigger.bind(this,n,r))}renderStage(t){this.agentInfos.forEach(t=>{const e=t.currentRad;t.currentMaxRad=e});const e={agentInfos:this.agentInfos,components:this.components,renderer:this,state:this.state,textSizer:this.svg.textSizer,theme:this.theme},n=this.components.get(t.type),r=n.renderPre(t,e),{agentIDs:s,topShift:i,asynchronousY:a}=j(r,this.currentY),o=this.checkAgentRange(s,a),l={addDef:this.addDef,agentInfos:this.agentInfos,blockLayer:this.blocks,components:this.components,drawAgentLine:(t,e,n=!1)=>{const r=this.agentInfos.get(t);this.drawAgentLine(r,e),r.latestYStart=n?null:e},fillLayer:this.backgroundFills,fullMaskLayer:this.fullMask,lineMaskLayer:this.lineMask,makeRegion:({stageOverride:e=null,unmasked:n=!1}={})=>{const r=this.svg.el("g").setClass("region"),s=e||t;return this.addHighlightObject(s.ln,r),this.forwardEvent(r,"mouseenter","mouseover",[s]),this.forwardEvent(r,"mouseleave","mouseout",[s]),this.forwardEvent(r,"click","click",[s]),this.forwardEvent(r,"dblclick","dblclick",[s]),r.attach(n?this.unmaskedShapes:this.shapes)},primaryY:o+i,renderer:this,state:this.state,svg:this.svg,textSizer:this.svg.textSizer,theme:this.theme,topY:o};let h=o;this.checkHidden(t)?(l.primaryY=o,n.renderHidden(t,l)):h=Math.max(h,n.render(t,l)||0),this.markAgentRange(s,h),this.currentY=h}positionAgents(){const t=[];this.agentInfos.forEach(e=>{let n=0;e.separations.forEach((t,r)=>{const s=this.agentInfos.get(r);s.index<e.index&&(n=Math.max(n,s.x+t))}),e.x=n,t.push(e)});let e={x:0};t.reverse().forEach(t=>{let n=e.x;e=t,t.anchorRight&&(t.separations.forEach((e,r)=>{const s=this.agentInfos.get(r);s.index>t.index&&(n=Math.min(n,s.x-e))}),t.x=n)}),this.agentInfos.forEach(({x:t,maxRPad:e,maxLPad:n})=>{this.minX=Math.min(this.minX,t-n),this.maxX=Math.max(this.maxX,t+e)})}buildAgentInfos(t){this.agentInfos=new Map,t.forEach((t,e)=>{this.agentInfos.set(t.id,{anchorRight:t.anchorRight,currentMaxRad:0,currentRad:0,formattedLabel:t.formattedLabel,id:t.id,index:e,isVirtualSource:t.isVirtualSource,latestY:0,latestYStart:null,maxLPad:0,maxRPad:0,options:t.options,separations:new Map,x:null})})}updateBounds(t){const e=(this.minX+this.maxX)/2,n=this.svg.textSizer.measure(this.title),r=n.height>0?-this.theme.titleMargin-n.height:0;this.title.set({x:e,y:r});const s=n.width/2,i=this.theme.outerMargin,a=Math.min(this.minX,e-s)-i,o=Math.max(this.maxX,e+s)+i,l=r-i,h=t+i;this.width=o-a,this.height=h-l;const d={height:this.height,width:this.width,x:a,y:l};this.fullMaskReveal.attrs(d),this.lineMaskReveal.attrs(d),this.svg.body.attr("viewBox",a+" "+l+" "+this.width+" "+this.height)}_resetState(){this.components.forEach(t=>{t.resetState(this.state)}),this.currentY=0,this.hideNest=0}_reset(t){t&&(this.knownThemeDefs.clear(),this.themeDefs.empty()),this.knownDefs.clear(),this.highlights.clear(),this.defs.empty(),this.fullMask.empty(),this.lineMask.empty(),this.backgroundFills.empty(),this.agentLines.empty(),this.blocks.empty(),this.shapes.empty(),this.unmaskedShapes.empty(),this.defs.add(this.fullMask.add(this.fullMaskReveal),this.lineMask.add(this.lineMaskReveal)),this._resetState()}setHighlight(t=null){const e=null===t?-1:t;this.currentHighlight!==e&&(this.highlights.has(this.currentHighlight)&&this.highlights.get(this.currentHighlight).forEach(t=>{t.delClass("focus")}),this.highlights.has(e)&&this.highlights.get(e).forEach(t=>{t.addClass("focus")}),this.currentHighlight=e)}isCollapsed(t){return this.collapsed.has(t)}setCollapseAll(t){if(t)throw new Error("Cannot collapse all");return 0!==this.collapsed.size&&(this.collapsed.clear(),!0)}_setCollapsed(t,e){return"number"==typeof t&&(e!==this.isCollapsed(t)&&(e?this.collapsed.add(t):this.collapsed.delete(t),!0))}setCollapsed(t,e=!0){return null===t?this.setCollapseAll(e):Array.isArray(t)?t.map(t=>this._setCollapsed(t,e)).some(t=>t):this._setCollapsed(t,e)}_switchTheme(t){const e=this.themeBuilder;return this.themeBuilder=this.getThemeNamed(t),this.themeBuilder!==e&&(this.theme=this.themeBuilder.build(this.svg)),this.theme.reset(),this.themeBuilder!==e}optimisedRenderPreReflow(t){const e=this._switchTheme(t.meta.theme);this._reset(e),this.metaCode.nodeValue=t.meta.code,this.theme.addDefs(this.addThemeDef),this.title.set({attrs:this.theme.titleAttrs,formatted:t.meta.title}),this.svg.textSizer.expectMeasure(this.title),this.minX=0,this.maxX=0,this.buildAgentInfos(t.agents),t.stages.forEach(this.prepareMeasurementsStage),this._resetState(),this.svg.textSizer.performMeasurementsPre()}optimisedRenderReflow(){this.svg.textSizer.performMeasurementsAct()}optimisedRenderPostReflow(t){this.visibleAgentIDs=["[","]"],t.stages.forEach(this.separationStage),this._resetState(),this.positionAgents(),t.stages.forEach(this.renderStage);const e=this.checkAgentRange(["[","]"],this.currentY),n=Math.max(e-this.theme.actionMargin,0);this.updateBounds(n);const r=this.currentHighlight;this.currentHighlight=-1,this.setHighlight(r),this.svg.textSizer.performMeasurementsPost(),this.svg.textSizer.resetCache()}render(t){this.optimisedRenderPreReflow(t),this.optimisedRenderReflow(),this.optimisedRenderPostReflow(t)}getThemeNames(){return Array.from(this.themes.keys()).filter(t=>""!==t)}getThemes(){return this.getThemeNames().map(t=>this.themes.get(t))}getThemeNamed(t){const e=this.themes.get(t);return e||this.themes.get("")}getAgentX(t){return this.agentInfos.get(t).x}dom(){return this.svg.body.element}}var De={name:"Handlee",woff2:"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"};class Le{constructor(){this.s=new Uint32Array(4)}reset(){this.s[0]=394173556,this.s[1]=2926575054,this.s[2]=1022685995,this.s[3]=1178902408}nextFloat(){let t=this.s[0],e=this.s[1];const n=this.s[2],r=this.s[3];return this.s[0]=n,this.s[1]=r,t^=t<<23|e>>>9,e^=e<<23,this.s[2]=t^n^t>>>17^n>>>26,this.s[3]=e^r^(t<<15|e>>>17)^(n<<6|r>>>26),(this.s[3]+r>>>0)%4294967296/4294967296}}const Ne=De.name,Oe=Ne+",cursive",ze=1.5,Ve=5,Be={normal:{stroke:"rgba(0,0,0,0.7)","stroke-width":.8,"stroke-linejoin":"round","stroke-linecap":"round"},thick:{stroke:"rgba(0,0,0,0.8)","stroke-width":1.2,"stroke-linejoin":"round","stroke-linecap":"round"}},Te={"font-family":Oe,"font-size":8,"line-height":ze},He={"font-family":Oe,"font-size":8,"line-height":ze,"text-anchor":"middle"},Pe={};class je{constructor(t,e){this.deltas=[0,-.3,-.6,-.75,-.45,0,.45,.75,.6,.3],e!==Pe&&this.deltas.reverse(),this.partWidth=6/this.deltas.length}getDelta(t){return this.deltas[t%this.deltas.length]+.5*Math.sin(.03*t)}}class qe extends lt{constructor(t,e=Pe){super(t),this.handedness=e===Pe?1:-1,this.random=new Le,this.wave=new je(4,e);const n={padding:{top:3,bottom:2},tag:{padding:{top:2,left:3,right:5,bottom:0},boxRenderer:this.renderTag.bind(this),labelAttrs:{"font-family":Oe,"font-weight":"bold","font-size":9,"line-height":ze,"text-anchor":"left"}},label:{minHeight:6,padding:{top:2,left:5,right:3,bottom:1},labelAttrs:{"font-family":Oe,"font-size":8,"line-height":ze,"text-anchor":"left"}}};Object.assign(this,{titleMargin:10,outerMargin:5,agentMargin:10,actionMargin:10,minActionMargin:3,agentLineHighlightRadius:4,agentCap:{box:{padding:{top:5,left:10,right:10,bottom:5},arrowBottom:12.8,labelAttrs:{"font-family":Oe,"font-size":12,"line-height":ze,"text-anchor":"middle"},boxRenderer:this.renderBox.bind(this)},database:{padding:{top:12,left:10,right:10,bottom:2},arrowBottom:12.8,boxRenderer:this.renderDB.bind(this,Object.assign({fill:"#FFFFFF","db-z":5},Be.normal)),labelAttrs:{"font-family":Ne,"font-size":12,"line-height":ze,"text-anchor":"middle"}},cross:{size:15,render:this.renderCross.bind(this)},bar:{height:6,render:this.renderBar.bind(this)},fade:{width:Math.ceil(2*Ve+2),height:6,extend:Math.ceil(.3*Ve+1)},none:{height:10}},connect:{loopbackRadius:6,line:{solid:{attrs:Object.assign({fill:"none"},Be.normal),renderFlat:this.renderFlatConnect.bind(this),renderRev:this.renderRevConnect.bind(this)},dash:{attrs:Object.assign({fill:"none","stroke-dasharray":"4, 2"},Be.normal),renderFlat:this.renderFlatConnect.bind(this),renderRev:this.renderRevConnect.bind(this)},wave:{attrs:Object.assign({fill:"none","stroke-linejoin":"round","stroke-linecap":"round"},Be.normal),renderFlat:this.renderFlatConnectWave.bind(this),renderRev:this.renderRevConnectWave.bind(this)}},arrow:{single:{width:5,height:6,attrs:Object.assign({fill:"rgba(0,0,0,0.9)"},Be.normal),render:this.renderArrowHead.bind(this)},double:{width:4,height:8,attrs:Object.assign({fill:"none"},Be.normal),render:this.renderArrowHead.bind(this)},cross:{short:5,radius:3,render:this.renderCross.bind(this)}},label:{padding:6,margin:{top:2,bottom:1},attrs:{"font-family":Oe,"font-size":8,"line-height":ze,"text-anchor":"middle"},loopbackAttrs:{"font-family":Oe,"font-size":8,"line-height":ze}},source:{radius:1,render:t.circleFactory({fill:"#000000",stroke:"#000000","stroke-width":1})},mask:{padding:{top:0,left:3,right:3,bottom:1}}},titleAttrs:{"font-family":Oe,"font-size":20,"line-height":ze,"text-anchor":"middle",class:"title"},agentLineAttrs:{"":Object.assign({fill:"none"},Be.normal),red:{stroke:"rgba(200,40,0,0.8)"}},blocks:{ref:{margin:{top:0,bottom:0},boxRenderer:this.renderRefBlock.bind(this),section:n},"":{margin:{top:0,bottom:0},boxRenderer:this.renderBlock.bind(this),collapsedBoxRenderer:this.renderMinBlock.bind(this),section:n,sepRenderer:this.renderSeparator.bind(this)}},notes:{text:{margin:{top:0,left:6,right:6,bottom:0},padding:{top:2,left:2,right:2,bottom:2},overlap:{left:10,right:10},boxRenderer:t.boxFactory({fill:"#FFFFFF"}),labelAttrs:Te},note:{margin:{top:0,left:5,right:5,bottom:0},padding:{top:5,left:5,right:10,bottom:5},overlap:{left:10,right:10},boxRenderer:this.renderNote.bind(this),labelAttrs:Te},state:{margin:{top:0,left:5,right:5,bottom:0},padding:{top:7,left:7,right:7,bottom:7},overlap:{left:10,right:10},boxRenderer:this.renderState.bind(this),labelAttrs:Te}},dividers:{"":{labelAttrs:He,padding:{top:2,left:5,right:5,bottom:2},extend:0,margin:0,render:()=>({})},line:{labelAttrs:He,padding:{top:2,left:5,right:5,bottom:2},extend:10,margin:0,render:this.renderLineDivider.bind(this)},delay:{labelAttrs:He,padding:{top:2,left:5,right:5,bottom:2},extend:0,margin:0,render:this.renderDelayDivider.bind(this,{dotSize:1,gapSize:2})},tear:{labelAttrs:He,padding:{top:2,left:5,right:5,bottom:2},extend:10,margin:10,render:this.renderTearDivider.bind(this,{fadeBegin:5,fadeSize:10,pattern:this.wave,lineAttrs:Be.normal})}}})}reset(){this.random.reset()}addDefs(t){t("sketch_font",()=>{const t=this.svg.el("style",null);return t.text("@font-face{font-family:"+De.name+';src:url("data:font/woff2;base64,'+De.woff2+'");}'),t})}vary(t,e=0){if(!t)return e;const n=this.random.nextFloat();return e+2*Math.asin(2*n-1)*t/Math.PI}lineNodes(t,e,{var1:n=1,var2:r=1,varX:s=1,varY:i=1,move:a=!0}){const o=Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)),l=Math.min(.2*Math.sqrt(o),Ve),h=this.vary(n*s*l,t.x),d=this.vary(n*i*l,t.y),g=this.vary(r*s*l,e.x),c=this.vary(r*i*l,e.y),u=function(t,e,n){return Math.max(e,Math.min(n,t))}((d-c)/(Math.abs(h-g)+.001),-1,1)/6+.5,p=this.vary(.5,.5)*l,f=this.vary(.5,.5)*l,m=h*(1-u)+g*u-p*this.handedness;return{nodes:(a?"M"+h+" "+d:"")+"C"+m+" "+(d*(1-u)+c*u-f)+","+g+" "+c+","+g+" "+c,p1:{x:h,y:d},p2:{x:g,y:c}}}renderLine(t,e,n){const r=this.lineNodes(t,e,n);return this.svg.el("path").attrs({d:r.nodes,fill:"none","stroke-dasharray":n.dash?"6, 5":"none"}).attrs(n.attrs||(n.thick?Be.thick:Be.normal))}boxNodes({x:t,y:e,width:n,height:r}){const s=this.lineNodes({x:t,y:e},{x:t+n,y:e},{}),i=this.lineNodes({x:t+n,y:e+r},{x:t,y:e+r},{move:!1}),a=this.lineNodes(s.p2,i.p1,{var1:0,var2:0,move:!1}),o=this.lineNodes(i.p2,s.p1,{var1:0,var2:.3,move:!1});return s.nodes+a.nodes+i.nodes+o.nodes}renderBox(t,{fill:e=null,thick:n=!1,attrs:r=null}={}){return this.svg.el("path").attrs({d:this.boxNodes(t),fill:e||"#FFFFFF"}).attrs(r||(n?Be.thick:Be.normal))}renderNote({x:t,y:e,width:n,height:r}){const s=this.lineNodes({x:t,y:e},{x:t+n-5,y:e},{}),i=this.lineNodes(s.p2,{x:t+n,y:e+5},{move:!1,var1:0}),a=this.lineNodes({x:t+n,y:e+r},{x:t,y:e+r},{move:!1}),o=this.lineNodes(i.p2,a.p1,{var1:0,var2:0,move:!1}),l=this.lineNodes(a.p2,s.p1,{var1:0,var2:.3,move:!1}),h=this.lineNodes(i.p1,{x:t+n-5,y:e+5},{var1:.3}),d=this.lineNodes(h.p2,i.p2,{var1:0,move:!1});return this.svg.el("g").add(this.svg.el("path").attrs({d:s.nodes+i.nodes+o.nodes+a.nodes+l.nodes,fill:"#FFFFFF"}).attrs(Be.normal),this.svg.el("path").attrs({d:h.nodes+d.nodes,fill:"none"}).attrs(Be.normal))}renderLineDivider({x:t,y:e,labelWidth:n,width:r,height:s}){let i=null;const a=e+s/2;return i=n>0?this.svg.el("g").add(this.renderLine({x:t,y:a},{x:t+(r-n)/2,y:a},{}),this.renderLine({x:t+(r+n)/2,y:a},{x:t+r,y:a},{})):this.renderLine({x:t,y:a},{x:t+r,y:a},{}),{shape:i}}renderFlatConnect(t,{x1:e,y1:n,x2:r,y2:s}){const i=this.lineNodes({x:e,y:n},{x:r,y:s},{varX:.3});return{shape:this.svg.el("path").attr("d",i.nodes).attrs(t),p1:i.p1,p2:i.p2}}renderRevConnect(t,{x1:e,y1:n,x2:r,y2:s,xR:i}){const a=Math.min(.06*(i-e),3),o=Math.min(.5*(i-e),6),l=e+this.vary(a,-1),h=n+this.vary(a,-1),d=i-o*this.vary(.2,1),g=n-this.vary(1,2),c=i,u=n+this.vary(1,1),p=i,f=s+this.vary(2),m=r+this.vary(a,-1),b=s+this.vary(a,-1);return{shape:this.svg.el("path").attr("d","M"+l+" "+h+"C"+l+" "+h+","+d+" "+g+","+c+" "+u+"S"+p+" "+f+","+m+" "+b).attrs(t),p1:{x:l,y:h},p2:{x:m,y:b}}}renderFlatConnectWave(t,{x1:e,y1:n,x2:r,y2:s}){const i=e+this.vary(.3),a=r+this.vary(.3),o=n+this.vary(1),l=s+this.vary(1);return{shape:this.svg.el("path").attr("d",this.svg.patternedLine(this.wave).move(i,o).line(a,l).cap().asPath()).attrs(t),p1:{x:i,y:o},p2:{x:a,y:l}}}renderRevConnectWave(t,{x1:e,y1:n,x2:r,y2:s,xR:i}){const a=e+this.vary(.3),o=r+this.vary(.3),l=n+this.vary(1),h=s+this.vary(1);return{shape:this.svg.el("path").attr("d",this.svg.patternedLine(this.wave).move(a,l).line(i,n).arc(i,(n+s)/2,Math.PI).line(o,h).cap().asPath()).attrs(t),p1:{x:a,y:l},p2:{x:o,y:h}}}renderArrowHead(t,{x:e,y:n,width:r,height:s,dir:i}){const a=r*this.vary(.2,1),o=s*this.vary(.3,1),l=a*i.dx,h=a*i.dy,d=.5*o*i.dx,g=.5*-o*i.dy,c=this.lineNodes({x:e+l-g,y:n+h-d},{x:e,y:n},{var1:2,var2:.2}),u=this.lineNodes(c.p2,{x:e+l+g,y:n+h+d},{var1:0,var2:2,move:!1}),p="none"===t.fill?{nodes:""}:this.lineNodes(u.p2,c.p1,{var1:0,var2:0,move:!1});return this.svg.el("path").attr("d",c.nodes+u.nodes+p.nodes).attrs(t)}renderState({x:t,y:e,width:n,height:r}){const s=Math.min(.06*n,3),i=Math.min(.06*r,3),a=t+s*this.vary(.6,1),o=e+i*this.vary(.6,1),l=t+n-s*this.vary(.6,1),h=e+i*this.vary(.6,1),d=t+s*this.vary(.6,1),g=e+r-i*this.vary(.6,1),c=t+n-s*this.vary(.6,1),u=e+r-i*this.vary(.6,1),p=t+n/2,f=e+r/2,m=s*this.vary(.2,1.2),b=i*this.vary(.2,1.2),y=e-Math.min(.005*n,1),x=e+r-Math.min(.01*n,2),w=t-Math.min(.01*r,2)*this.handedness,k=w+n;return this.svg.el("path").attr("d","M"+a+" "+o+"C"+(a+m)+" "+(o-b)+","+(p-n*this.vary(.03,.3))+" "+y+","+p+" "+y+"S"+(l-m)+" "+(h-b)+","+l+" "+h+"S"+k+" "+(f-r*this.vary(.03,.3))+","+k+" "+f+"S"+(c+m)+" "+(u-b)+","+c+" "+u+"S"+(p+n*this.vary(.03,.3))+" "+x+","+p+" "+x+"S"+(d+m)+" "+(g+b)+","+d+" "+g+"S"+w+" "+(f+r*this.vary(.03,.3))+","+w+" "+f+"S"+(a-m)+" "+(o+b)+","+a+" "+o+"Z").attr("fill","#FFFFFF").attrs(Be.normal)}renderRefBlock(t){const e=this.boxNodes(t);return{shape:this.svg.el("path").attrs({d:e,fill:"none"}).attrs(Be.thick),mask:this.svg.el("path").attrs({d:e,fill:"#000000"}),fill:this.svg.el("path").attrs({d:e,fill:"#FFFFFF"})}}renderBlock(t){return this.renderBox(t,{fill:"none",thick:!0})}renderMinBlock(t){return this.renderRefBlock(t)}renderTag({x:t,y:e,width:n,height:r}){const s=t+n,i=e+r,a=this.lineNodes({x:s+3,y:e},{x:s-2,y:i},{}),o=this.lineNodes(a.p2,{x:t,y:i+1},{var1:0,move:!1}),l=a.nodes+o.nodes;return this.svg.el("g").add(this.svg.el("path").attrs({d:l+"L"+t+" "+e,fill:"#FFFFFF"}),this.svg.el("path").attrs({d:l,fill:"#FFFFFF"}).attrs(Be.normal))}renderSeparator({x1:t,y1:e,x2:n,y2:r}){return this.renderLine({x:t,y:e},{x:n,y:r},{thick:!0,dash:!0})}renderBar({x:t,y:e,width:n,height:r}){return this.renderBox({x:t,y:e,width:n,height:r},{fill:"#000000"})}renderCross({x:t,y:e,radius:n}){const r=this.vary(.2,1)*n,s=this.lineNodes({x:t-r,y:e-r},{x:t+r,y:e+r},{}),i=this.vary(.2,1)*n,a=this.lineNodes({x:t+i,y:e-i},{x:t-i,y:e+i},{});return this.svg.el("path").attrs({d:s.nodes+a.nodes,fill:"none"}).attrs(Be.normal)}renderAgentLine({x:t,y0:e,y1:n,width:r,className:s,options:i}){const a=this.optionsAttributes(this.agentLineAttrs,i);return r>0?this.renderBox({x:t-r/2,y:e,width:r,height:n-e},{fill:"none",attrs:a}).setClass(s):this.renderLine({x:t,y:e},{x:t,y:n},{varY:.3,attrs:a}).setClass(s)}}class Ye{constructor(t=Pe){const e=t===Pe;this.name=e?"sketch":"sketch left handed",this.handedness=t}build(t){return new qe(t,this.handedness)}}Object.assign(Ye,{RIGHT:Pe,LEFT:{}});const Ue=/^([ \t]*)(.*)$/,We={after:".!+",end:/[ \t\r\n]$/,start:/^[ \t\r\n:,]/},Xe=/^"(\\.|[^"])*$/,Qe=/[\r\n:,"<>\-~]/,Je=/["\\]/g,Ze=[new class{constructor(){this.name="basic"}build(t){return new pt(t)}},new class{constructor(){this.name="monospace"}build(t){return new Tt(t)}},new class{constructor(){this.name="chunky"}build(t){return new wt(t)}},new Ye(Ye.RIGHT),new Ye(Ye.LEFT)],Ke=new ie,_e=new Lt,$e=Ke.getCodeMirrorMode();class tn extends kt{constructor(t=null,e={}){super();let n=null;t&&"object"==typeof t?(n=t,this.code=n.code):(n=e,this.code=t),Object.assign(this,{exporter:new St,generator:_e,isInteractive:!1,latestProcessed:null,parser:Ke,registerCodeMirrorMode:nt,renderer:new Ge(Object.assign({document:function(t){return t?t.ownerDocument||null:"undefined"==typeof window?null:window.document}(n.container),themes:Ze},n)),textSizerFactory:n.textSizerFactory||null}),this.renderer.addEventForwarding(this),n.container&&n.container.appendChild(this.dom()),n.interactive&&this.addInteractivity(),"string"==typeof this.code&&!1!==n.render&&this.render()}clone(t={}){const e=t.container||this.renderer.dom();return new tn(Object.assign({code:this.code,components:this.renderer.components,container:null,document:e.ownerDocument,interactive:this.isInteractive,namespace:null,textSizerFactory:this.textSizerFactory,themes:this.renderer.getThemes()},t))}set(t="",{render:e=!0}={}){this.code!==t&&(this.code=t,e&&this.render())}process(t){const e=this.parser.parse(t);return this.generator.generate(e)}addTheme(t){this.renderer.addTheme(t)}setHighlight(t){this.renderer.setHighlight(t)}isCollapsed(t){return this.renderer.isCollapsed(t)}setCollapsed(t,e=!0,{render:n=!0}={}){return!!this.renderer.setCollapsed(t,e)&&(n&&this.latestProcessed&&this.render(this.latestProcessed),!0)}collapse(t,e){return this.setCollapsed(t,!0,e)}expand(t,e){return this.setCollapsed(t,!1,e)}toggleCollapsed(t,e){return this.setCollapsed(t,!this.isCollapsed(t),e)}expandAll(t){return this.setCollapsed(null,!1,t)}getThemeNames(){return this.renderer.getThemeNames()}getThemes(){return this.renderer.getThemes()}_updateSize({width:t=null,height:e=null,zoom:n=null}){null!==t?(null===e?this.renderer.height*=t/this.renderer.width:this.renderer.height=e,this.renderer.width=t):null!==e?(this.renderer.width*=e/this.renderer.height,this.renderer.height=e):null!==n&&(this.renderer.width*=n,this.renderer.height*=n)}getSVGCodeSynchronous({size:t={}}={}){return this._updateSize(t),this.exporter.getSVGContent(this.renderer)}getSVGCode(t){return Promise.resolve(this.getSVGCodeSynchronous(t))}getSVGSynchronous({size:t={}}={}){return this._updateSize(t),this.exporter.getSVGURL(this.renderer)}getSVG({size:t={}}={}){return this._updateSize(t),Promise.resolve({latest:!0,url:this.getSVGSynchronous()})}getCanvas({resolution:t=1,size:e={}}={}){return this._updateSize(e),new Promise(e=>{this.exporter.getCanvas(this.renderer,t,e)})}getPNG({resolution:t=1,size:e={}}={}){return this._updateSize(e),new Promise(e=>{this.exporter.getPNGURL(this.renderer,t,(t,n)=>{e({latest:n,url:t})})})}getSize(){return{height:this.renderer.height,width:this.renderer.width}}_revertParent(t){const e=this.renderer.dom();e.parentNode!==t.originalParent&&(e.parentNode.removeChild(e),t.originalParent&&t.originalParent.appendChild(e))}_sendRenderError(t){this._revertParent(this.renderState),this.renderState.error=!0,this.trigger("error",[this,t])}optimisedRenderPreReflow(t=null){const e=this.renderer.dom();this.renderState={error:!1,originalParent:e.parentNode,processed:t};const n=this.renderState;e.isConnected||(n.originalParent&&n.originalParent.removeChild(e),e.ownerDocument.body.appendChild(e));try{n.processed||(n.processed=this.process(this.code)),this.renderer.optimisedRenderPreReflow(n.processed)}catch(t){this._sendRenderError(t)}}optimisedRenderReflow(){try{this.renderState.error||this.renderer.optimisedRenderReflow()}catch(t){this._sendRenderError(t)}}optimisedRenderPostReflow(){const t=this.renderState;try{t.error||this.renderer.optimisedRenderPostReflow(t.processed)}catch(t){this._sendRenderError(t)}this.renderState=null,t.error||(this._revertParent(t),this.latestProcessed=t.processed,this.trigger("render",[this]))}render(t=null){function e(t,e){n=e}let n=null;if(this.addEventListener("error",e),this.optimisedRenderPreReflow(t),this.optimisedRenderReflow(),this.optimisedRenderPostReflow(),this.removeEventListener("error",e),n)throw n}setContainer(t=null){const e=this.dom();e.parentNode&&e.parentNode.removeChild(e),t&&t.appendChild(e)}addInteractivity(){this.isInteractive||(this.isInteractive=!0,this.addEventListener("click",t=>{this.toggleCollapsed(t.ln)}))}extractCodeFromSVG(t){return rt(t)}renderAll(t){return st(t)}dom(){return this.renderer.dom()}}Object.assign(tn,{Exporter:St,Generator:Lt,Parser:ie,Renderer:Ge,addTheme:function(t){Ze.push(t)},convert:at,convertAll:function(t=null,e="sequence-diagram"){let n=null,r=null;"string"==typeof t?(n=null,r=t):(n=t,r=e);let s=null;s=n&&void 0!==n.length?n:(n||window.document).getElementsByClassName(r);const i=[];for(let t=0;t<s.length;++t)i.push(s[t]);at(i)},extractCodeFromSVG:rt,getDefaultThemeNames:function(){return Ze.map(t=>t.name)},registerCodeMirrorMode:nt,renderAll:st,themes:Ze});const en={SequenceDiagram:tn};"undefined"!=typeof exports?Object.assign(exports,en):window.define&&window.define.amd?(Object.assign(tn,en),window.define(()=>tn)):(window.document.addEventListener("DOMContentLoaded",()=>{tn.convertAll()},{once:!0}),window.CodeMirror&&tn.registerCodeMirrorMode(window.CodeMirror),Object.assign(window,en))}();