import{D as e,E as t,S as i}from"./SequenceDiagram-71841f1d.js";var n=[{code:"{Agent1} -> {Agent2}: {Message}",title:"Simple arrow (synchronous)"},{code:"{Agent1} --\x3e {Agent2}: {Message}",title:"Arrow with dotted line (response)"},{code:"{Agent1} ->> {Agent2}: {Message}",title:"Open arrow (asynchronous)"},{code:"{Agent1} -x {Agent2}: {Message}",title:"Lost message"},{code:"{Agent1} ~> {Agent2}: {Message}",title:"Wavy line"},{code:"{Agent1} -> {Agent1}: {Message}",title:"Self-connection"},{code:"{Agent1} -> ...{id}\n...{id} -> {Agent2}: {Message}",preview:"begin A, B\nA -> ...x\n...x -> B: Message",title:"Asynchronous message"},{code:"* -> {Agent1}: {Message}",title:"Found message"},{code:"{Agent1} -> {Agent2}\n& {Agent1} -> {Agent3}: {Broadcast}",title:"Broadcast message"},{code:"{Agent1} -> +{Agent2}: {Request}\n{Agent1} <-- -{Agent2}: {Response}",title:"Request/response pair"},{code:"{Agent1} -> *{Agent2}: {Request}\n{Agent1} <-- !{Agent2}: {Response}",title:"Inline agent creation / destruction"},{code:"{Agent1} -> {Agent2}: {Request}\n{Agent1} <-- {Agent2}: {Response}\nend {Agent2}",preview:"begin A\n::\nA -> B: Request\nA <-- B: Response\nend B",title:"Agent creation / destruction"},{code:"relabel",preview:"begin A, B\n::\nA -> B: Message\nrelabel\nA -> B: Message",title:"Relabel all agents"},{code:"relabel {Agent}",preview:"begin A, B\n::\nA -> B: Message\nrelabel A\nA -> B: Message",title:"Relabel specific agents"},{code:'autolabel "[<inc>] <label>"',preview:'autolabel "[<inc>] <label>"\nA -> B: Foo\nA <- B: Bar\nA -> B: Baz',title:"Numbered labels"},{code:"if {Condition1}\n  {Agent1} -> {Agent2}\nelse if {Condition2}\n  {Agent1} -> {Agent2}\nelse\n  {Agent1} -> {Agent2}\nend",preview:"begin A, B\nif Condition1\n  A -> B\nelse if Condition2\n  A -> B\nelse\n  A -> B\nend",title:"Conditional blocks"},{code:"repeat {Condition}\n  {Agent1} -> {Agent2}\nend",preview:"begin A, B\nrepeat Condition\n  A -> B\nend",title:"Repeated block"},{code:"begin reference: {Label} as {Name}\n{Agent1} -> {Name}\nend {Name}",preview:'begin A\nbegin reference: "See 1.3" as myRef\nA -> myRef\nmyRef -> A\nend myRef',title:"Reference"},{code:"begin reference over {Covered}: {Label} as {Name}\n{Agent1} -> {Name}\nend {Name}",preview:'begin A, B, C\nbegin reference over B, C: "See 1.3" as myRef\nA -> myRef\nmyRef -> A\nend myRef',title:"Reference over agents"},{code:"group {Label}\n  {Agent1} -> {Agent2}\nend",preview:"begin A, B\ngroup Label\n  A -> B\nend",title:"Group"},{code:"note over {Agent1}: {Message}",title:"Note over agent"},{code:"note over {Agent1}, {Agent2}: {Message}",title:"Note over multiple agents"},{code:"note left of {Agent1}: {Message}",title:"Note left of agent"},{code:"note right of {Agent1}: {Message}",title:"Note right of agent"},{code:"note between {Agent1}, {Agent2}: {Message}",title:"Note between agents"},{code:"{Agent1} -> {Agent2}\n& note right of {Agent2}: {Message}",title:"Inline note"},{code:"state over {Agent1}: {State}",title:"State over agent"},{code:"[ -> {Agent1}: {Message1}\n{Agent1} -> ]: {Message2}",title:"Arrows to/from the sides"},{code:"{Agent1} -~ ]: {Message1}\n{Agent1} <-~ ]: {Message2}",title:"Fading arrows"},{code:"text right: {Message}",preview:'A -> B\nsimultaneously:\ntext right: "Message\\non the\\nside"',title:"Text beside the diagram"},{code:"divider space with height 10: {message}",preview:"begin A, B, C, D, E, F\ndivider space with height 30: message",title:"Vertical space divider"},{code:"divider line with height 10: {message}",preview:"begin A, B, C, D, E, F\ndivider line with height 30: message",title:"Line divider"},{code:"divider delay with height 10: {message}",preview:"begin A, B, C, D, E, F\ndivider delay with height 30: message",title:"Delay divider"},{code:"divider tear with height 10: {message}",preview:"begin A, B, C, D, E, F\ndivider tear with height 30: message",title:"Tear divider"},{code:"title {Title}",preview:"headers box\ntitle Title\nA -> B",title:"Title"},{code:"**{text}**",preview:"A -> B: **bold**",surround:!0,title:"Bold markdown"},{code:"_{text}_",preview:"A -> B: _italic_",surround:!0,title:"Italic markdown"},{code:"~{text}~",preview:"A -> B: ~strikeout~",surround:!0,title:"Strikeout markdown"},{code:"<u>{text}</u>",preview:"A -> B: <u>underline</u>",surround:!0,title:"Underline markdown"},{code:"<o>{text}</o>",preview:"A -> B: <o>overline</o>",surround:!0,title:"Overline markdown"},{code:"<sup>{text}</sup>",preview:"A -> B: super<sup>script</sup>",surround:!0,title:"Superscript markdown"},{code:"<sub>{text}</sub>",preview:"A -> B: sub<sub>script</sub>",surround:!0,title:"Subscript markdown"},{code:"`{text}`",preview:"A -> B: `mono`",surround:!0,title:"Monospace markdown"},{code:"<red>{text}</red>",preview:"A -> B: <red>red</red>",surround:!0,title:"Red markdown"},{code:"<mark>{text}</mark>",preview:"A -> B: <mark>highlight</mark>",surround:!0,title:"Highlight markdown"},{code:"{Agent} is red",preview:"headers box\nA is red\nbegin A",title:"Red agent line"},{code:"{Agent} is a person",preview:"headers box\nA is a person\nbegin A",title:"Person indicator"},{code:"{Agent} is a database",preview:"headers box\nA is a database\nbegin A",title:"Database indicator"},{code:"theme monospace",preview:"headers box\ntitle mono\ntheme monospace\nA -> B",title:"Monospace theme"},{code:"theme chunky",preview:"headers box\ntitle chunky\ntheme chunky\nA -> B",title:"Chunky theme"},{code:"theme sketch",preview:"headers box\ntitle sketch\ntheme sketch\nA -> B",title:"Sketch theme"},{code:"terminators cross",preview:"begin A\nterminators cross",title:"Cross terminators"},{code:"terminators fade",preview:"begin A\nterminators fade",title:"Fade terminators"},{code:"terminators bar",preview:"begin A\nterminators bar",title:"Bar terminators"},{code:"terminators box",preview:"begin A\nterminators box",title:"Box terminators"}];const s=/^[0-9]{1,2}$/;function o(){const e=window.location.hash;return e?e.substr(1):""}class r{constructor(e=(()=>null)){this.hash=o(),window.addEventListener("hashchange",(()=>{o()!==this.hash&&e()}))}getRawHash(){return o()}maxSlots(){return 100}getSlot(){const e=o();return s.test(e)?Number(e):null}setSlot(e){this.hash=e.toFixed(0),window.location.hash=this.hash}}e.WrappedElement.prototype.fastClick=function(){const e={x:-1,y:0};return this.on("touchstart",(t=>{const[i]=t.touches;e.x=i.pageX,e.y=i.pageY}),{passive:!0}).on("touchend",(t=>{if(-1===e.x||0!==t.touches.length||1!==t.changedTouches.length)return void(e.x=-1);const[i]=t.changedTouches;Math.abs(e.x-i.pageX)<10&&Math.abs(e.y-i.pageY)<10&&(t.preventDefault(),t.target.click()),e.x=-1}))};e.WrappedElement.prototype.split=function(e,t,i,n){const s=n.filter((({node:e})=>e));if(s.length<2)return this.add(s.map((({node:e})=>e))),this;if(s.length>2)throw new Error("unsupported");this.addClass(t?"split-v":"split-h");for(const{node:e,initialSize:i,minSize:n}of s)t?e.styles({flex:i,minHeight:n+"px"}):e.styles({flex:i,minWidth:n+"px"});const o=e.el("div").addClass("divider");let r=0,a=0,l=0;const d=e=>{let n=(t?e.clientY:e.clientX)-l;n<r+s[0].minSize+i.snap&&(n=r+s[0].minSize),n>a-s[1].minSize-i.snap&&(n=a-s[1].minSize);const o=(n-r)/(a-r);s[0].node.styles({flex:o}),s[1].node.styles({flex:1-o})};return o.on("pointerdown",(e=>{e.preventDefault();const i=o.element.getBoundingClientRect(),n=this.element.getBoundingClientRect();l=t?e.clientY-(i.top+i.bottom)/2:e.clientX-(i.left+i.right)/2,r=t?n.top:n.left,a=t?n.bottom:n.right,o.element.setPointerCapture(e.pointerId),o.on("pointermove",d)})),o.on("pointerup",(e=>{o.off("pointermove",d),o.element.releasePointerCapture(e.pointerId)})),this.add(s[0].node,o,s[1].node)};const a=/\{[^}]+\}/g;function l(e){return e.length>0&&"\n"!==e.charAt(e.length-1)?e+"\n":e}function d(e,t){let i=0,n=0;for(;;){const s=e.indexOf("\n",i)+1;if(t<s||0===s)return{ch:t-i,line:n};i=s,++n}}function h(e,{from:t,to:i}){return!(e.line<t.line||e.line===t.line&&e.ch<t.ch||e.line>i.line||e.line===i.line&&e.ch>i.ch)}function c(e,t,i,n){const s=e.getLine(t),o=t===i.line?i.ch:0;return{chOffset:o,line:t===n.line?s.slice(o,n.ch):s.slice(o)}}class u extends t{constructor(e,t,{mode:i="",value:n=""}){super(),this.mode=i,this.marker=null,this.isAutocompleting=!1,this.enhanced=!1,this.code=e.el("textarea").setClass("editor-simple").val(n).on("input",(()=>this.trigger("change"))).on("focus",(()=>this.trigger("focus"))).attach(t),this._enhance()}markLineHover(e=null){this.unmarkLineHover(),null!==e&&this.enhanced&&(this.marker=this.code.markText({ch:0,line:e},{ch:0,line:e+1},{className:"hover",clearOnEnter:!0,inclusiveLeft:!1,inclusiveRight:!1}))}unmarkLineHover(){this.marker&&(this.marker.clear(),this.marker=null)}selectLine(e=null){null!==e&&this.enhanced&&(this.code.setSelection({ch:0,line:e},{ch:0,line:e+1},{bias:-1,origin:"+focus"}),this.code.focus())}enterParams(e,t,i){if(!i.includes("{"))return;this.cancelParams&&this.cancelParams();const n=this.code.getDoc(),s=n.setBookmark(t),o=[],r=(e,t)=>{switch(t.keyCode){case 13:case 9:this.isAutocompleting||t.preventDefault(),this.advanceParams();break;case 27:this.isAutocompleting||(t.preventDefault(),this.cancelParams())}},a=()=>{if(0===this.paramMarkers.length)return;const e=this.paramMarkers[0].find(),[t]=n.listSelections();h(t.anchor,e)&&h(t.head,e)||(this.cancelParams(),this.code.setSelection(t.anchor,t.head))};this.paramMarkers=[],this.cancelParams=()=>{this.code.off("keydown",r),this.code.off("cursorActivity",a),this.paramMarkers.forEach((e=>e.clear())),this.paramMarkers=null,this.code.setCursor(s.find()),s.clear(),this.cancelParams=null,this.advanceParams=null},this.advanceParams=()=>{this.paramMarkers.forEach((e=>e.clear())),this.paramMarkers.length=0,this.nextParams(e,s,i,o)},this.code.on("keydown",r),this.code.on("cursorActivity",a),this.advanceParams()}nextParams(e,t,i,n){const s=function(e,t){a.lastIndex=0;for(let i=null;i=a.exec(e);)if(!t.includes(i[0]))return i[0];return null}(i,n);if(!s)return void this.cancelParams();n.push(s);const o=this.code.getDoc(),r=[],l=t.find();for(let t=e.line;t<=l.line;++t){const{chOffset:i,line:n}=c(o,t,e,l);for(let e=0;-1!==(e=n.indexOf(s,e));e+=s.length){const n={ch:i+e,line:t},a={ch:i+e+s.length,line:t};r.push({anchor:n,head:a}),this.paramMarkers.push(o.markText(n,a,{className:"param",clearWhenEmpty:!1,inclusiveLeft:!0,inclusiveRight:!0}))}}r.length>0?o.setSelections(r,0):this.cancelParams()}hasSelection(){const e=this.code.getCursor("from"),t=this.code.getCursor("to");return e.line!==t.line||e.ch!==t.ch}internalAddSurroundCode(e){if(this.enhanced)if(this.hasSelection())this.code.replaceSelection(e.replace(/\{.*\}/,this.code.getSelection()),"end","library");else{const t=this.code.getCursor("head");this.code.replaceSelection(e,null,"library");const i={ch:t.ch+e.length,line:t.line};this.enterParams(t,i,e)}else{const t=this.value(),i=this.code.element.selectionStart,n=this.code.element.selectionEnd,s=e.replace(/\{.*\}/,t.substring(i,n));this.code.val(t.substr(0,i)+s+t.substr(n)).select(i+s.length),this.trigger("change")}}internalAddIndependentCode(e){if(this.enhanced){const t=this.code.getCursor("head"),i={ch:0,line:t.line+(t.ch>0?1:0)};let n=l(e);i.line>=this.code.lineCount()&&(n="\n"+n),this.code.replaceRange(n,i,null,"library");const s=e.split("\n").length,o={ch:0,line:i.line+s};this.enterParams(i,o,e)}else{const t=this.value(),i=this.code.element.selectionStart,n=("\n"+t+"\n").indexOf("\n",i),s=l(t.substr(0,n))+l(e);this.code.val(s+t.substr(n)).select(s.length),this.trigger("change")}}addCodeBlock(e,t=!1){this.code.focus(),t?this.internalAddSurroundCode(e):this.internalAddIndependentCode(e)}value(){return this.enhanced?this.code.getDoc().getValue():this.code.element.value}setValue(e){if(this.enhanced){const t=this.code.getDoc();t.setValue(e),t.clearHistory()}else this.code.val(e)}_enhance(){import("./codemirror-editor-510a45f0.js").then((({CodeMirror:e})=>{const t=globalThis.overrideCodeMirror||e,i={};this.trigger("enhance",[t,i]);const n=this.code,{selectionStart:s,selectionEnd:o,value:r}=n.element,a=n.focussed(),l=new t(n.element.parentNode,{extraKeys:{"Cmd-/":e=>e.toggleComment({padding:""}),"Cmd-Enter":"autocomplete","Ctrl-/":e=>e.toggleComment({padding:""}),"Ctrl-Enter":"autocomplete","Ctrl-Space":"autocomplete","Shift-Tab":e=>e.execCommand("indentLess"),Tab:e=>e.execCommand("indentMore")},globals:i,lineNumbers:!0,mode:this.mode,showTrailingSpace:!0,value:r});n.detach(),l.getDoc().setSelection(d(r,s),d(r,o));let h=0;l.on("keydown",((e,t)=>{h=t.keyCode})),l.on("change",((e,i)=>{if(this.trigger("change"),"+input"===i.origin){if(13===h)return void(h=0)}else if("complete"!==i.origin)return;t.commands.autocomplete(e,null,{completeSingle:!1})})),l.on("focus",(()=>this.trigger("focus"))),l.on("cursorActivity",(()=>{const e=l.getCursor("from"),t=l.getCursor("to");this.trigger("cursorActivity",[e,t])})),l.on("hint-shown",(()=>{this.isAutocompleting=!0})),l.on("endCompletion",(()=>{this.isAutocompleting=!1})),a&&l.focus(),this.code=l,this.enhanced=!0})).catch(console.warn)}}function g(e,t){const i=e.toString(),n=i.indexOf(".");return-1===n||i.length-n-1<=t?i:e.toFixed(t)}function m(e=null){return null!==e&&!Number.isNaN(e)}class p{constructor(e="",t=""){this.renderBase=e,this.editBase=t}setRenderBase(e){this.renderBase=e}setEditBase(e){this.editBase=e}_convertCode(e,t=!1){let i=e.split("\n").map(encodeURIComponent);if(t)for(;i.length>0&&""===i[i.length-1];)--i.length;else i=i.filter((e=>""!==e));return i.join("/")}_convertWidthHeight(e,t){let i="";return m(e)&&(i+="w"+g(Math.max(e,0),4)),m(t)&&(i+="h"+g(Math.max(t,0),4)),i+"/"}_convertZoom(e){return 1===e?"":"z"+g(Math.max(e,0),4)+"/"}_convertSize({height:e,width:t,zoom:i}){return m(t)||m(e)?this._convertWidthHeight(t,e):m(i)?this._convertZoom(i):""}getRenderURL(e,t={}){return this.renderBase+this._convertSize(t)+this._convertCode(e)+".svg"}getEditURL(e){return this.editBase+"#edit:"+this._convertCode(e,!0)}}class w{constructor(){this.value=""}set(e){this.value=e}get(){return this.value}remove(){this.value=""}}class v{constructor({sequenceDiagram:e,defaultCode:t="",library:i=[],links:n=[],storage:s=new w,touchUI:o=!1}){this.diagram=e,this.defaultCode=t,this.storage=s,this.library=i,this.links=n,this.minScale=1.5,this.touchUI=o,this.debounced=null,this.latestSeq=null,this.renderedSeq=null,this.pngDirty=!0,this.updatingPNG=!1,this.marker=null,this._downloadSVGClick=this._downloadSVGClick.bind(this),this._downloadPNGClick=this._downloadPNGClick.bind(this),this._downloadPNGFocus=this._downloadPNGFocus.bind(this),this._downloadURLClick=this._downloadURLClick.bind(this),this._hideDropStyle=this._hideDropStyle.bind(this),this.diagram.on("render",(()=>{this.updateMinSize(this.diagram.getSize()),function(e){let t=e.trim();t.length>20&&(t=t.substr(0,18).trim()+"…"),document.title=(t?`${t} — `:"")+"Sequence Diagram"}(this.diagram.getTitle()),this.pngDirty=!0})).on("mouseover",(e=>this.code.markLineHover(e.ln))).on("mouseout",(()=>this.code.unmarkLineHover())).on("click",(e=>{this.code.unmarkLineHover(),this.code.selectLine(e.ln),this._hideURLBuilder()})).on("dblclick",(e=>{this.diagram.toggleCollapsed(e.ln),this._hideURLBuilder()}))}buildURLBuilder(){const e=this.dom.el("div").setClass("copied").add("Copied to Clipboard");this.urlOutput=this.dom.el("input").setClass("output").attr("readonly","readonly").on("focus",(()=>{this.urlOutput.select(0,this.urlOutput.element.value.length)}));const t=this.dom.el("button").setClass("copy").attr("title","Copy to clipboard").fastClick().on("click",(()=>{this.touchUI&&this.urlOutput.styles({display:"block"}),this.urlOutput.focus().select(0,this.urlOutput.element.value.length).element.ownerDocument.execCommand("copy"),t.focus(),this.container.delClass("keyinput"),this.touchUI&&this.urlOutput.styles({display:"none"}),e.styles({display:"block",opacity:1,transition:"none"}),setTimeout((()=>e.styles({opacity:0,transition:"opacity 0.5s linear"})),1e3),setTimeout((()=>e.styles({display:"none"})),1500)})),i=()=>{this.renderOpts.styles({display:this.modeEdit.element.checked?"none":"block"}),this._refreshURL()};this.modeRender=this.dom.el("input").attrs({checked:"checked",name:"export-mode",type:"radio",value:"render"}).on("change",i),this.modeEdit=this.dom.el("input").attrs({name:"export-mode",type:"radio",value:"edit"}).on("change",i),this.modeMarkdown=this.dom.el("input").attrs({name:"export-mode",type:"radio",value:"markdown"}).on("change",i),this.urlWidth=this.dom.el("input").attrs({min:0,placeholder:"auto",step:"any",type:"number"}).on("input",(()=>{this.urlZoom.val("1"),this._refreshURL()})),this.urlHeight=this.dom.el("input").attrs({min:0,placeholder:"auto",step:"any",type:"number"}).on("input",(()=>{this.urlZoom.val("1"),this._refreshURL()})),this.urlZoom=this.dom.el("input").attrs({min:0,step:"any",type:"number",value:1}).on("input",(()=>{this.urlWidth.val(""),this.urlHeight.val(""),this._refreshURL()})),this.renderOpts=this.dom.el("div").add(this.dom.el("label").add("width ",this.urlWidth),", ",this.dom.el("label").add("height ",this.urlHeight),this.dom.el("span").setClass("or").add("or"),this.dom.el("label").add("zoom ",this.urlZoom));const n=this.dom.el("div").setClass("config").add(this.dom.el("div").setClass("export-mode").add(this.dom.el("label").add(this.modeRender,"View"),this.dom.el("label").add(this.modeEdit,"Edit"),this.dom.el("label").add(this.modeMarkdown,"Markdown")),this.renderOpts,this.urlOutput,t,e),s=this.dom.el("div").setClass("urlbuilder").styles({display:"none"}).add(this.dom.el("div").setClass("message").add("Loading…")),o="undefined"==typeof window?"http://localhost":window.location.href;this.renderService=new p,this.renderService.setEditBase(new URL(".",o).href);const r="render/";var a;return(a=r,"undefined"==typeof fetch?Promise.reject(new Error):fetch(a).then((e=>{if(!e.ok)throw new Error(e.statusText);return e}))).then((e=>e.text())).then((e=>{let t=e.trim();t&&!t.startsWith("<")||(t=r),this.renderService.setRenderBase(new URL(t,o).href),s.empty().add(n),this._refreshURL()})).catch((()=>{s.empty().add(this.dom.el("div").setClass("message").add("No online rendering service available."))})),s}_refreshURL(){const e=this.code.value(),t={height:Number.parseFloat(this.urlHeight.element.value),width:Number.parseFloat(this.urlWidth.element.value),zoom:Number.parseFloat(this.urlZoom.element.value||"1")};let i="";if(this.modeMarkdown.element.checked){const n=this.renderService.getEditURL(e),s=this.renderService.getRenderURL(e,t);i=`[![${this.diagram.getTitle().replace(/[^a-zA-Z0-9 \-_'"]/g,"").trim()}](${s})](${n})`}else i=this.modeEdit.element.checked?this.renderService.getEditURL(e):this.renderService.getRenderURL(e,t);this.urlOutput.val(i)}_showURLBuilder(){this.builderVisible||(this.builderVisible=!0,this.touchUI?this.urlBuilder.styles({bottom:"-210px",display:"block"}):this.urlBuilder.styles({display:"block",height:"0px",padding:"0px",width:this.optsHold.element.clientWidth+"px"}),clearTimeout(this.builderTm),this.builderTm=setTimeout((()=>{this.touchUI?this.urlBuilder.styles({bottom:0}):(this.urlBuilder.styles({height:"150px",padding:"10px",width:"400px"}),this.optsHold.styles({"box-shadow":"10px 10px 25px 12px rgba(0,0,0,0.3)"}))}),0),this._refreshURL())}_hideURLBuilder(){this.builderVisible&&(this.builderVisible=!1,this.touchUI?this.urlBuilder.styles({bottom:-this.urlBuilder.element.clientHeight-60+"px"}):(this.urlBuilder.styles({height:"0px",padding:"0px",width:"0px"}),this.optsHold.styles({"box-shadow":"none"})),this.container.delClass("keyinput"),clearTimeout(this.builderTm),this.builderTm=setTimeout((()=>{this.urlBuilder.styles({display:"none"})}),200))}buildOptionsDownloads(){return this.downloadPNG=this.dom.el("a").text("Export PNG").attrs({download:"SequenceDiagram.png",href:"#"}).on(["focus","mouseover","mousedown"],this._downloadPNGFocus).on("touchend",this._downloadPNGFocus).on("click",this._downloadPNGClick),this.downloadSVG=this.dom.el("a").text("SVG").attrs({download:"SequenceDiagram.svg",href:"#"}).fastClick().on("click",this._downloadSVGClick),this.downloadURL=this.dom.el("a").text("URL").attrs({href:"#"}).fastClick().on("click",this._downloadURLClick),this.urlBuilder=this.buildURLBuilder(),this.optsHold=this.dom.el("div").setClass("options downloads").add(this.downloadPNG,this.downloadSVG,this.downloadURL,this.urlBuilder),this.optsHold}buildLibrary(e){const t=this.library.map((t=>{const i=this.dom.el("div").attr("title",t.title||t.code),n=this.dom.el("div").setClass("library-item").add(i).fastClick().on("click",(()=>this.code.addCodeBlock(t.code,t.surround))).attach(e);return this.diagram.clone({code:(s=t.preview||t.code,"headers fade\nterminators fade\n"+s.replace(/\{Agent([0-9]*)\}/g,((e,t)=>void 0===t?"A":String.fromCharCode("A".charCodeAt(0)+Number(t)-1))).replace(/[{}]/g,"")),container:i.element,render:!1}).on("error",((e,s)=>{window.console.warn("Failed to render preview",s),n.attr("class","library-item broken"),i.text(t.code)}));var s}));try{this.diagram.renderAll(t)}catch(e){}return e}buildCodePane(){const e=this.dom.el("div").setClass("pane-code");return this.code=new u(this.dom,e,{mode:"sequence",value:this.storage.get()||this.defaultCode}),this.code.on("enhance",((e,t)=>{this.diagram.registerCodeMirrorMode(e),t.themes=this.diagram.getThemeNames()})).on("change",(()=>this.update(!1))).on("cursorActivity",((e,t)=>{this.diagram.setHighlight(Math.min(e.line,t.line))})).on("focus",(()=>this._hideURLBuilder())),e}buildLibPane(){return 0===this.library.length?null:this.dom.el("div").setClass("pane-library").add(this.dom.el("div").setClass("pane-library-scroller").add(this.buildLibrary(this.dom.el("div").setClass("pane-library-inner"))))}buildViewPane(){return this.viewPaneInner=this.dom.el("div").setClass("pane-view-inner").add(this.diagram.dom()).on("touchstart",(()=>this._hideURLBuilder()),{passive:!0}).on("mousedown",(()=>this._hideURLBuilder())),this.errorMsg=this.dom.el("div").setClass("msg-error"),this.dom.el("div").setClass("pane-view").add(this.dom.el("div").setClass("pane-view-scroller").add(this.viewPaneInner),this.errorMsg)}build(t){this.dom=new e(t.ownerDocument),this.container=this.dom.wrap(t).on("dragover",(e=>{e.preventDefault(),!function(e,t){if(!e.dataTransfer.items&&0===e.dataTransfer.files.length)return[...e.dataTransfer.types].includes("Files");const i=e.dataTransfer.items||e.dataTransfer.files;return 1===i.length&&i[0].type===t}(e,"image/svg+xml")?e.dataTransfer.dropEffect="none":(e.dataTransfer.dropEffect="copy",this._showDropStyle())})).on("dragleave",this._hideDropStyle).on("dragend",this._hideDropStyle).on("drop",(e=>{e.preventDefault(),this._hideDropStyle();const t=function(e,t){const i=e.dataTransfer.items||e.dataTransfer.files;if(1!==i.length||i[0].type!==t)return null;const[n]=i;return n.getAsFile?n.getAsFile():n}(e,"image/svg+xml");t&&this.loadFile(t)})).on("focusin",(()=>this.container.addClass("keyinput"))).on("focusout",(()=>this.container.delClass("keyinput")));const i=this.buildCodePane(),n=this.buildLibPane(),s=this.buildViewPane(),o=this.links.map((e=>{const t=this.touchUI?e.touchLabel:e.label;return t&&this.dom.el("a").attrs({href:e.href,rel:"noopener",target:e.target||""}).text(t)})).filter((e=>e));if(this.touchUI)this.buildOptionsDownloads(),this.container.addClass("touch").add(this.dom.el("div").setClass("pane-hold").split(this.dom,true,{snap:20},[{initialSize:80,minSize:10,node:s},{initialSize:20,minSize:10,node:i}]),n.styles({display:"none",top:"100%"}),this.urlBuilder,this.dom.el("div").setClass("optbar").add(...o,this.downloadPNG.text("PNG"),this.downloadSVG.text("SVG"),this.downloadURL.text("URL")));else{const e=this.dom.el("div").setClass("pane-side").split(this.dom,true,{snap:5},[{initialSize:70,minSize:100,node:i},{initialSize:30,minSize:5,node:n}]);this.container.add(this.dom.el("div").setClass("pane-hold").split(this.dom,false,{snap:70},[{initialSize:30,minSize:10,node:e},{initialSize:70,minSize:10,node:s}]),this.dom.el("div").setClass("options links").add(o),this.buildOptionsDownloads())}"undefined"!=typeof window&&window.addEventListener("keydown",(e=>{27===e.keyCode&&this._hideURLBuilder()})),setTimeout(this.update.bind(this),0)}updateMinSize({width:e,height:t}){this.viewPaneInner.styles({minHeight:Math.ceil(t*this.minScale)+"px",minWidth:Math.ceil(e*this.minScale)+"px"})}redrawDebounced(e,t){t<=0?this.redraw(e):(clearTimeout(this.debounced),this.latestSeq=e,this.debounced=setTimeout((()=>this.redraw(e)),t))}redraw(e){clearTimeout(this.debounced),this.debounced=null,this.renderedSeq=e,this.diagram.render(e)}markError(e){"object"==typeof e&&e.message?this.errorMsg.text(e.message):this.errorMsg.text(e),this.errorMsg.addClass("error")}markOK(){this.errorMsg.text("").delClass("error")}loadFile(e){return function(e){return new Promise((t=>{const i=new FileReader;i.addEventListener("loadend",(()=>{t(i.result)}),{once:!0}),i.readAsText(e)}))}(e).then((e=>{const t=this.diagram.extractCodeFromSVG(e);t&&(this.code.setValue(t),this.diagram.expandAll({render:!1}),this.update(!0),this.diagram.setHighlight(null))}))}update(e=!0){this._hideURLBuilder();const t=this.code.value();this.storage.set(t);let i=null;try{i=this.diagram.process(t)}catch(e){return void this.markError(e)}this.markOK();let n=0;if(!e&&this.renderedSeq){const e=this.renderedSeq;i.agents.length!==e.agents.length?n=500:i.stages.length!==e.stages.length&&(n=250)}this.redrawDebounced(i,n)}forceRender(){this.debounced&&(clearTimeout(this.debounced),this.redraw(this.latestSeq))}updatePNGLink(){return this.forceRender(),!(this.updatingPNG||!this.pngDirty)&&(this.pngDirty=!1,this.updatingPNG=!0,this.diagram.getPNG({resolution:4}).then((({url:e,latest:t})=>{t&&(this.downloadPNG.attr("href",e),this.updatingPNG=!1)})),!0)}_showDropStyle(){this.container.addClass("drop-target")}_hideDropStyle(){this.container.delClass("drop-target")}_downloadPNGFocus(){this.updatePNGLink()}_downloadPNGClick(e){(this.updatingPNG||this.updatePNGLink())&&e.preventDefault(),this._hideURLBuilder()}_downloadSVGClick(){this.forceRender();const e=this.diagram.getSVGSynchronous();this.downloadSVG.attr("href",e),this._hideURLBuilder()}_downloadURLClick(e){e.preventDefault(),this.builderVisible?this._hideURLBuilder():this._showURLBuilder()}}class b{constructor(e){this.id=e}set(e){try{window.localStorage.setItem(this.id,e)}catch(e){}}get(){try{return window.localStorage.getItem(this.id)||""}catch(e){return""}}remove(){try{window.localStorage.removeItem(this.id)}catch(e){}}}class f{constructor(e,t){this.slotManager=e,this.slotStorage=t,this.slot=this.slotManager.getSlot(),this.value=this.get(),this.originalValue=this.value,this.loadTime=Date.now(),this.internalStorageListener=this.internalStorageListener.bind(this),window.addEventListener("storage",this.internalStorageListener),this.checkSlot()}getCurrentValue(){return Date.now()<this.loadTime+500?this.originalValue:this.value}key(){return this.slotStorage.getSlotKey(this.slot)}checkSlot(){const e=this.key();window.localStorage.removeItem(`chk-${e}`),window.localStorage.removeItem(`res-${e}`),window.localStorage.removeItem(`ack-${e}`),window.localStorage.setItem(`chk-${e}`,"1")}cloneSlot(){const e=this.slotManager.maxSlots(),t=this.slotStorage.nextAvailableSlot(e);if(!t)return;const i=this.getCurrentValue();this.slotStorage.set(t,i),this.slot=t,this.slotManager.setSlot(t),i!==this.value&&document.location.reload()}internalStorageListener({storageArea:e,key:t,newValue:i}){if(e!==window.localStorage)return;const n=this.key();t===n&&i!==this.value&&(null===i&&window.localStorage.setItem(n,this.value),window.localStorage.removeItem(`res-${n}`),window.localStorage.setItem(`res-${n}`,"1")),t===`chk-${n}`&&i&&window.localStorage.setItem(`res-${n}`,"1"),t===`res-${n}`&&i&&(window.localStorage.removeItem(`chk-${n}`),window.localStorage.removeItem(`res-${n}`),window.localStorage.setItem(`ack-${n}`,"1"),this.cloneSlot()),t===`ack-${n}`&&i&&(window.localStorage.removeItem(`ack-${n}`,"1"),window.localStorage.setItem(n,this.value))}set(e){this.value=e,this.slotStorage.set(this.slot,e)}get(){return this.slotStorage.get(this.slot)}remove(){this.slotStorage.remove(this.slot)}close(){window.removeEventListener("storage",this.internalStorageListener)}}const A=/^s[0-9]+$/;class S{getSlotKey(e){return`s${e}`}getAllSlots(){const e=[];try{for(const t in window.localStorage)A.test(t)&&e.push(Number(t.substr(1)))}catch(e){}return e}nextAvailableSlot(e=Number.MAX_SAFE_INTEGER){try{for(let t=1;t<e;++t)if(null===window.localStorage.getItem(this.getSlotKey(t)))return t;return null}catch(e){return null}}set(e,t){try{window.localStorage.setItem(this.getSlotKey(e),t)}catch(e){}}get(e){try{return window.localStorage.getItem(this.getSlotKey(e))||""}catch(e){return""}}remove(e){try{window.localStorage.removeItem(this.getSlotKey(e))}catch(e){}}}var y=(t,n)=>{if(null!==t.getSlot())return Promise.resolve();const s=n.getAllSlots().sort(((e,t)=>e-t));if(!s.length)return t.setSlot(1),Promise.resolve();const o=new e(window.document),r=o.el("div").setClass("pick-document").add(o.el("h1").text("Diagrams on this device:")).add(o.el("p").text("(right-click to delete)")).attach(document.body);const a=new i;return new Promise((e=>{const i=s.map((t=>{const i=n.get(t),s=o.el("div").attr("title",i.trim()),l=o.el("a").attr("href",`#${t}`).setClass("pick-document-item").add(s).on("click",(i=>{i.preventDefault(),e(t)})).on("contextmenu",(e=>{e.preventDefault(),function(e){window.confirm("Delete this diagram?")&&(n.remove(e),window.location.reload())}(t)})).attach(r);return a.clone({code:i,container:s.element,render:!1}).on("error",((e,t)=>{window.console.warn("Failed to render preview",t),l.attr("class","pick-document-item broken"),s.text(i)}))}));try{a.renderAll(i)}catch(e){}s.length<t.maxSlots()&&o.el("div").setClass("pick-document-item new").add(o.el("div").attr("title","New document")).on("click",(()=>e(n.nextAvailableSlot()))).attach(r)})).then((e=>{r.detach(),t.setSlot(e)}))};window.addEventListener("load",(()=>{const e=window.document.getElementById("loader"),[t]=e.getElementsByTagName("nav"),s=t.getElementsByTagName("a"),o=[];for(let e=0;e<s.length;++e){const t=s[e];o.push({href:t.getAttribute("href"),label:t.textContent,target:t.getAttribute("target"),touchLabel:t.dataset.touch})}const a=new S;!function(e){const t=new b("src"),i=t.get();if(i){const n=e.nextAvailableSlot();e.set(n,i),t.remove()}}(a);const l=new r((()=>{window.location.reload()}));!function(e,t){const i="edit:",n=e.getRawHash();if(!n.startsWith(i))return;let s=n.substr(i.length).split("/").map(decodeURIComponent).join("\n");if(!s)return;s.endsWith("\n")||(s+="\n");const o=t.nextAvailableSlot();t.set(o,s),e.setSlot(o)}(l,a),e.parentNode.removeChild(e),y(l,a).then((()=>{new v({defaultCode:'title Labyrinth\n\nBowie -> Goblin: You remind me of the babe\nGoblin -> Bowie: What babe?\nBowie -> Goblin: The babe with the power\nGoblin -> Bowie: What power?\nnote right of Bowie, Goblin: Most people get muddled here!\nBowie -> Goblin: "The power of voodoo"\nGoblin -> Bowie: "Who-do?"\nBowie -> Goblin: You do!\nGoblin -> Bowie: Do what?\nBowie -> Goblin: Remind me of the babe!\n\nBowie -> Audience: Sings\n\nterminators box\n',library:n,links:o,sequenceDiagram:new i,storage:new f(l,a),touchUI:"ontouchstart"in window}).build(window.document.body)}))}));
